<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—ä–∑–¥–∞–π –ø—Ä–∏–∫–∞–∑–∫–∞ / Create a Tale</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-gradient-1: #e0f7fa;
            --bg-gradient-2: #e1bee7;
            --bg-gradient-3: #fff9c4;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --primary-btn: #FF9800;
            --primary-btn-hover: #F57C00;
            --secondary-btn: #4CAF50;
            --refresh-btn: #2196F3;
            --lock-btn: #E91E63;
            --modal-bg: #ffffff;
            --modal-text: #444;

            --cat-hero-bg: #e8f5e9; --cat-hero-border: #4CAF50;
            --cat-item-bg: #fffde7; --cat-item-border: #FFC107;
            --cat-place-bg: #ffebee; --cat-place-border: #F44336;
            --cat-action-bg: #e3f2fd; --cat-action-border: #2196F3;
        }

        body.dark-mode {
            --bg-gradient-1: #0f2027; --bg-gradient-2: #203a43; --bg-gradient-3: #2c5364;
            --text-color: #e0e0e0; --card-bg: #1e1e1e; --modal-bg: #1e1e1e; --modal-text: #ccc;
            --cat-hero-bg: #1b3320; --cat-hero-border: #2e7d32;
            --cat-item-bg: #332f00; --cat-item-border: #fbc02d;
            --cat-place-bg: #3e1a1a; --cat-place-border: #d32f2f;
            --cat-action-bg: #0d2740; --cat-action-border: #1565c0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(-45deg, var(--bg-gradient-1), var(--bg-gradient-2), var(--bg-gradient-3));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-color);
            margin: 0; padding: 10px 5px; 
            height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; 
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- HEADER --- */
        h1 { 
            margin: 2px 0 5px 0; 
            font-size: 1.2rem; 
            font-weight: 900; color: #ff5722; 
            text-align: center; flex: 0 0 auto;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
            z-index: 10;
            padding: 0 50px; 
        }
        body.dark-mode h1 { text-shadow: 1px 1px 0px rgba(0,0,0,0.5); }

        .top-btn {
            position: absolute; top: 8px; width: 32px; height: 32px;
            border-radius: 50%; border: none; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index: 200;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }
        .lang-btn { left: 8px; background: white; color: #333; border: 2px solid #333; }
        .dark-btn { left: 45px; background: #333; color: #fff; border: 2px solid #555; }
        body.dark-mode .dark-btn { background: #fff; color: #333; }
        .info-btn { right: 8px; background: var(--refresh-btn); color: white; font-size: 1.1rem; }

        /* --- LEGEND & CONTROLS --- */
        .legend-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
            margin-bottom: 5px; font-size: 0.7rem; 
            background: var(--card-bg); 
            padding: 4px 10px; border-radius: 15px; flex: 0 0 auto;
            color: var(--text-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 700;
        }
        .legend-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .legend-item.dimmed { opacity: 0.3; text-decoration: line-through; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.hero { background: var(--cat-hero-border); }
        .dot.item { background: var(--cat-item-border); }
        .dot.place { background: var(--cat-place-border); }
        .dot.action { background: var(--cat-action-border); }

        .controls { 
            margin-bottom: 5px; flex: 0 0 auto; z-index: 10; 
            display: flex; gap: 8px; justify-content: center;
        }
        select { 
            font-size: 0.9rem; padding: 4px 8px; border-radius: 10px; 
            border: 2px solid var(--primary-btn); 
            background: var(--card-bg); color: var(--text-color);
            font-family: 'Nunito', sans-serif; font-weight: 700; outline: none;
        }

        /* --- GAME BOARD --- */
        .game-board {
            flex: 1 1 auto; 
            width: 100%; max-width: 600px;
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            grid-auto-rows: 1fr; 
            gap: 6px; 
            padding: 2px;
            overflow: hidden; 
            min-height: 0; 
        }

        .card {
            background-color: var(--card-bg); border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 4px; position: relative;
            border-bottom: 3px solid rgba(0,0,0,0.1); cursor: pointer;
            height: 100%; width: 100%;
            transition: transform 0.1s;
        }
        .card:active { transform: scale(0.96); }

        .card.cat-hero { background: var(--cat-hero-bg); color: #1b5e20; }
        .card.cat-item { background: var(--cat-item-bg); color: #f57f17; }
        .card.cat-place { background: var(--cat-place-bg); color: #b71c1c; }
        .card.cat-action { background: var(--cat-action-bg); color: #0d47a1; }
        .card.speaking { outline: 3px solid var(--refresh-btn); }
        .card.locked { opacity: 0.85; border-style: dashed; border-color: #888; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px); }

        .card-icon { 
            font-size: 8vmin; 
            line-height: 1; margin-bottom: 5px; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); 
        }
        .card-text { 
            font-size: 3.5vmin; 
            font-weight: 800; text-align: center; line-height: 1.1; 
            width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            color: inherit;
        }
        body.dark-mode .card-text { color: var(--text-color); }

        @media (min-width: 600px) {
            .card-icon { font-size: 3rem; }
            .card-text { font-size: 1rem; }
        }

        /* --- –ë–£–¢–û–ù–ò –í–™–†–•–£ –ö–ê–†–¢–ê–¢–ê --- */
        .card-btn {
            position: absolute; width: 28px; height: 28px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 5; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-size: 0.9rem; background: rgba(255,255,255,0.9);
        }
        body.dark-mode .card-btn { background: rgba(50,50,50,0.9); }
        
        .swap-btn { top: 4px; right: 4px; color: var(--refresh-btn); border: 2px solid var(--refresh-btn); flex-direction: row; gap: 2px; padding: 0 2px; width: auto; min-width: 28px; }
        .swap-dots { display: flex; gap: 2px; }
        .swap-dot { display: inline-block; width: 5px; height: 5px; background: var(--refresh-btn); border-radius: 50%; }
        .lock-btn { top: 4px; left: 4px; color: #ccc; border: 2px solid #ccc; }
        .card.locked .lock-btn { color: var(--lock-btn); border-color: var(--lock-btn); background: var(--card-bg); }

        /* --- –î–û–õ–ù–ò –ë–£–¢–û–ù–ò --- */
        .actions-container { 
            flex: 0 0 auto; margin-top: 5px; margin-bottom: 2px;
            display: flex; gap: 10px; width: 98%; max-width: 500px; justify-content: center; 
        }
        .action-btn {
            border: none; padding: 10px; font-size: 1rem; font-weight: 900;
            border-radius: 25px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            color: white; flex: 1; font-family: 'Nunito', sans-serif;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .action-btn:active { transform: translateY(2px); }
        .roll-btn { background: linear-gradient(135deg, var(--primary-btn), var(--primary-btn-hover)); flex: 2; animation: pulseBtn 2s infinite; }
        .save-btn { background-color: var(--secondary-btn); flex: 1; font-size: 0.8rem; }

        @keyframes pulseBtn { 0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(255, 152, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); } }

        /* --- –ú–û–î–ê–õ --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--modal-bg); color: var(--modal-text); margin: 20px; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 2rem; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        .modal h2 { color: #ff5722; margin-top: 0; }
        
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        @keyframes popIn { 0% { transform: scale(0.6); opacity: 0; } 60% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px) rotate(-4deg); } 75% { transform: translateX(4px) rotate(4deg); } }

        /* --- DESKTOP FIX --- */
        @media (min-width: 768px) {
            .game-board { 
                grid-template-columns: repeat(4, 1fr) !important; 
                grid-auto-rows: min-content; 
                gap: 15px; padding: 15px;
            }
            .card { aspect-ratio: 9/13; height: auto; }
            h1 { font-size: 1.8rem; margin: 10px 0; }
        }
    </style>
</head>
<body>

    <button class="top-btn lang-btn" onclick="toggleLanguage()">BG</button>
    <button class="top-btn dark-btn" onclick="toggleDarkMode()">üåô</button>
    <button class="top-btn info-btn" onclick="openModal()">?</button>

    <h1 id="ui-title">–°—ä–∑–¥–∞–π –ø—Ä–∏–∫–∞–∑–∫–∞</h1>

    <div class="legend-container">
        <div class="legend-item" id="leg-hero"><span class="dot hero"></span> <span id="ui-hero">–ì–µ—Ä–æ–π</span></div>
        <div class="legend-item" id="leg-action"><span class="dot action"></span> <span id="ui-action">–î–µ–π—Å—Ç–≤–∏–µ</span></div>
        <div class="legend-item" id="leg-item"><span class="dot item"></span> <span id="ui-item">–ü—Ä–µ–¥–º–µ—Ç</span></div>
        <div class="legend-item" id="leg-place"><span class="dot place"></span> <span id="ui-place">–ú—è—Å—Ç–æ</span></div>
    </div>

    <div class="controls">
        <select id="level-select" onchange="rollAll()">
            <option value="beginner" id="opt-beginner">–ù–∞—á–∏–Ω–∞–µ—â</option>
            <option value="advanced" id="opt-advanced">–ù–∞–ø—Ä–µ–¥–Ω–∞–ª</option>
            <option value="expert" id="opt-expert">–ï–∫—Å–ø–µ—Ä—Ç</option>
        </select>
        
        <select id="count-select" onchange="rollAll()">
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
        </select>
    </div>

    <div id="game-board" class="game-board"></div>

    <div class="actions-container">
        <button class="action-btn save-btn" onclick="takeScreenshot()">
            üì∏ <span id="ui-save">–ó–∞–ø–∞–∑–∏</span>
        </button>
        <button class="action-btn roll-btn" onclick="rollAllWithAnimation()">
            ‚ú® <span id="ui-roll">–ù–û–í–ê –ò–°–¢–û–†–ò–Ø</span>
        </button>
    </div>

    <div id="infoModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal(event, true)">&times;</span>
            <div id="modal-text-content"></div>
        </div>
    </div>

    <script>
        // --- –î–ê–ù–ù–ò ---
        const uiText = {
            bg: {
                title: "–°—ä–∑–¥–∞–π –ø—Ä–∏–∫–∞–∑–∫–∞",
                hero: "–ì–µ—Ä–æ–π", item: "–ü—Ä–µ–¥–º–µ—Ç", place: "–ú—è—Å—Ç–æ", action: "–î–µ–π—Å—Ç–≤–∏–µ",
                optBeginner: "–ù–∞—á–∏–Ω–∞–µ—â (3)", optAdvanced: "–ù–∞–ø—Ä–µ–¥–Ω–∞–ª (4)", optExpert: "–ï–∫—Å–ø–µ—Ä—Ç (–ú–∏–∫—Å)",
                save: "–ó–ê–ü–ê–ó–ò", roll: "–ù–û–í–ê –ò–°–¢–û–†–ò–Ø",
                modalTitle: "üìñ –ö–∞–∫ —Å–µ –∏–≥—Ä–∞–µ?",
                modalSteps: ["1. –ò–∑–±–µ—Ä–µ—Ç–µ –Ω–∏–≤–æ.", "2. –ò–∑–±–µ—Ä–µ—Ç–µ –±—Ä–æ–π –∫–∞—Ä—Ç–∏.", "3. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ '–ù–æ–≤–∞ –ò—Å—Ç–æ—Ä–∏—è'!"],
                modalTipsTitle: "üí° –ù–∏–≤–∞:",
                modalTips: ["<strong>–ù–∞—á–∏–Ω–∞–µ—â:</strong> –õ–µ—Å–Ω–æ.", "<strong>–ù–∞–ø—Ä–µ–¥–Ω–∞–ª:</strong> –ò–∑—Ä–µ—á–µ–Ω–∏—è.", "<strong>–ï–∫—Å–ø–µ—Ä—Ç:</strong> –•–∞–æ—Å."]
            },
            en: {
                title: "Create a Tale",
                hero: "Hero", item: "Item", place: "Place", action: "Action",
                optBeginner: "Beginner (3)", optAdvanced: "Advanced (4)", optExpert: "Expert (Mix)",
                save: "SAVE", roll: "NEW STORY",
                modalTitle: "üìñ How to play?",
                modalSteps: ["1. Select level.", "2. Select count.", "3. Click 'New Story'!"],
                modalTipsTitle: "üí° Levels:",
                modalTips: ["<strong>Beginner:</strong> Easy.", "<strong>Advanced:</strong> Sentences.", "<strong>Expert:</strong> Chaos."]
            }
        };

        const db = [
            // HEROES
            { id: 1, text: { bg: "–ú–æ–º—á–µ", en: "Boy" }, icon: "üë¶", cat: "hero" },
            { id: 2, text: { bg: "–ú–æ–º–∏—á–µ", en: "Girl" }, icon: "üëß", cat: "hero" },
            { id: 3, text: { bg: "–ë–µ–±–µ", en: "Baby" }, icon: "üë∂", cat: "hero" },
            { id: 4, text: { bg: "–î—è–¥–æ", en: "Grandfather" }, icon: "üë¥", cat: "hero" },
            { id: 5, text: { bg: "–°—É–ø–µ—Ä–≥–µ—Ä–æ–π", en: "Superhero" }, icon: "ü¶∏", cat: "hero" },
            { id: 6, text: { bg: "–ü–∏—Ä–∞—Ç", en: "Pirate" }, icon: "üè¥‚Äç‚ò†Ô∏è", cat: "hero" },
            { id: 7, text: { bg: "–ö—É—á–µ", en: "Dog" }, icon: "üê∂", cat: "hero" },
            { id: 8, text: { bg: "–ö–æ—Ç–∫–∞", en: "Cat" }, icon: "üê±", cat: "hero" },
            { id: 9, text: { bg: "–ó–∞–π—á–µ", en: "Bunny" }, icon: "üê∞", cat: "hero" },
            { id: 10, text: { bg: "–ü—Ç–∏—á–µ", en: "Bird" }, icon: "üê¶", cat: "hero" },
            { id: 11, text: { bg: "–ö–æ–Ω—á–µ", en: "Horse" }, icon: "üê¥", cat: "hero" },
            { id: 12, text: { bg: "–°–ª–æ–Ω—á–µ", en: "Elephant" }, icon: "üêò", cat: "hero" },
            { id: 13, text: { bg: "–î—Ä–∞–∫–æ–Ω", en: "Dragon" }, icon: "üê≤", cat: "hero" },
            { id: 14, text: { bg: "–î–∏–Ω–æ–∑–∞–≤—ä—Ä", en: "Dinosaur" }, icon: "ü¶ñ", cat: "hero" },
            { id: 15, text: { bg: "–†–æ–±–æ—Ç", en: "Robot" }, icon: "ü§ñ", cat: "hero" },
            { id: 16, text: { bg: "–ò–∑–≤—ä–Ω–∑–µ–º–Ω–æ", en: "Alien" }, icon: "üëΩ", cat: "hero" },
            { id: 17, text: { bg: "–§–µ—è", en: "Fairy" }, icon: "üßö", cat: "hero" },
            { id: 18, text: { bg: "–ß—É–¥–æ–≤–∏—â–µ", en: "Monster" }, icon: "üëæ", cat: "hero" },
            { id: 73, text: { bg: "–ö—Ä–∞–ª", en: "King" }, icon: "ü§¥", cat: "hero" },
            { id: 74, text: { bg: "–ö—Ä–∞–ª–∏—Ü–∞", en: "Queen" }, icon: "üë∏", cat: "hero" },
            { id: 75, text: { bg: "–ü–æ–ª–∏—Ü–∞–π", en: "Police" }, icon: "üëÆ", cat: "hero" },
            { id: 76, text: { bg: "–õ–µ–∫–∞—Ä", en: "Doctor" }, icon: "üë©‚Äç‚öïÔ∏è", cat: "hero" },
            { id: 77, text: { bg: "–£—á–µ–Ω", en: "Scientist" }, icon: "üßë‚Äçüî¨", cat: "hero" },
            { id: 78, text: { bg: "–ü—Ä–∏–∑—Ä–∞–∫", en: "Ghost" }, icon: "üëª", cat: "hero" },
            { id: 79, text: { bg: "–ù–∏–Ω–¥–∂–∞", en: "Ninja" }, icon: "ü•∑", cat: "hero" },
            // ITEMS
            { id: 19, text: { bg: "–¢–æ–ø–∫–∞", en: "Ball" }, icon: "‚öΩ", cat: "item" },
            { id: 20, text: { bg: "–ú–µ—á–µ", en: "Teddy Bear" }, icon: "üß∏", cat: "item" },
            { id: 21, text: { bg: "–ö–æ–ª–∏—á–∫–∞", en: "Car" }, icon: "üöó", cat: "item" },
            { id: 22, text: { bg: "–ö–æ—Ä–æ–Ω–∞", en: "Crown" }, icon: "üëë", cat: "item" },
            { id: 23, text: { bg: "–ë–∞–ª–æ–Ω", en: "Balloon" }, icon: "üéà", cat: "item" },
            { id: 24, text: { bg: "–ö–Ω–∏–≥–∞", en: "Book" }, icon: "üìñ", cat: "item" },
            { id: 25, text: { bg: "–í—ä–ª—à–µ–±–Ω–∞ –ø—Ä—ä—á–∫–∞", en: "Magic Wand" }, icon: "ü™Ñ", cat: "item" },
            { id: 26, text: { bg: "–õ—ä–∂–∏—Ü–∞", en: "Spoon" }, icon: "ü•Ñ", cat: "item" },
            { id: 27, text: { bg: "–û–±—É–≤–∫–∏", en: "Shoes" }, icon: "üëü", cat: "item" },
            { id: 28, text: { bg: "–ö–ª—é—á", en: "Key" }, icon: "üîë", cat: "item" },
            { id: 29, text: { bg: "–§–µ–Ω–µ—Ä—á–µ", en: "Flashlight" }, icon: "üî¶", cat: "item" },
            { id: 30, text: { bg: "–ü–æ–¥–∞—Ä—ä–∫", en: "Gift" }, icon: "üéÅ", cat: "item" },
            { id: 31, text: { bg: "–ö–æ–ª–µ–ª–æ", en: "Bicycle" }, icon: "üö≤", cat: "item" },
            { id: 32, text: { bg: "–†–∞–∫–µ—Ç–∞", en: "Rocket" }, icon: "üöÄ", cat: "item" },
            { id: 33, text: { bg: "–õ–æ–¥–∫–∞", en: "Boat" }, icon: "‚õµ", cat: "item" },
            { id: 34, text: { bg: "–í–ª–∞–∫", en: "Train" }, icon: "üöÇ", cat: "item" },
            { id: 35, text: { bg: "–¢–æ—Ä—Ç–∞", en: "Cake" }, icon: "üéÇ", cat: "item" },
            { id: 36, text: { bg: "–°–ª–∞–¥–æ–ª–µ–¥", en: "Ice Cream" }, icon: "üç¶", cat: "item" },
            { id: 80, text: { bg: "–¢–µ–ª–µ—Ñ–æ–Ω", en: "Phone" }, icon: "üì±", cat: "item" },
            { id: 81, text: { bg: "–ö–æ–º–ø—é—Ç—ä—Ä", en: "Computer" }, icon: "üíª", cat: "item" },
            { id: 82, text: { bg: "–ú–µ—á", en: "Sword" }, icon: "üó°Ô∏è", cat: "item" },
            { id: 83, text: { bg: "–©–∏—Ç", en: "Shield" }, icon: "üõ°Ô∏è", cat: "item" },
            { id: 84, text: { bg: "–ö–∞—Ä—Ç–∞", en: "Map" }, icon: "üó∫Ô∏è", cat: "item" },
            { id: 85, text: { bg: "–ü–∏—Ü–∞", en: "Pizza" }, icon: "üçï", cat: "item" },
            { id: 86, text: { bg: "–®–∞–ø–∫–∞", en: "Hat" }, icon: "üé©", cat: "item" },
            // PLACES
            { id: 37, text: { bg: "–ö—ä—â–∞", en: "House" }, icon: "üè†", cat: "place" },
            { id: 38, text: { bg: "–£—á–∏–ª–∏—â–µ", en: "School" }, icon: "üè´", cat: "place" },
            { id: 39, text: { bg: "–ü—ä—Ä–∑–∞–ª–∫–∞", en: "Slide" }, icon: "üõù", cat: "place" },
            { id: 40, text: { bg: "–ì–æ—Ä–∞", en: "Forest" }, icon: "üå≤", cat: "place" },
            { id: 41, text: { bg: "–ü–ª–∞–∂", en: "Beach" }, icon: "üèñÔ∏è", cat: "place" },
            { id: 42, text: { bg: "–ö–æ—Å–º–æ—Å", en: "Space" }, icon: "ü™ê", cat: "place" },
            { id: 43, text: { bg: "–°–ª—ä–Ω—Ü–µ", en: "Sun" }, icon: "‚òÄÔ∏è", cat: "place" },
            { id: 44, text: { bg: "–õ—É–Ω–∞", en: "Moon" }, icon: "üåô", cat: "place" },
            { id: 45, text: { bg: "–î—ä–≥–∞", en: "Rainbow" }, icon: "üåà", cat: "place" },
            { id: 46, text: { bg: "–î—ä–∂–¥", en: "Rain" }, icon: "üåßÔ∏è", cat: "place" },
            { id: 47, text: { bg: "–°–Ω—è–≥", en: "Snow" }, icon: "‚ùÑÔ∏è", cat: "place" },
            { id: 48, text: { bg: "–¶–≤–µ—Ç–µ", en: "Flower" }, icon: "üå∏", cat: "place" },
            { id: 49, text: { bg: "–ó–∞–º—ä–∫", en: "Castle" }, icon: "üè∞", cat: "place" },
            { id: 50, text: { bg: "–û—Å—Ç—Ä–æ–≤", en: "Island" }, icon: "üèùÔ∏è", cat: "place" },
            { id: 51, text: { bg: "–õ–µ–≥–ª–æ", en: "Bed" }, icon: "üõèÔ∏è", cat: "place" },
            { id: 52, text: { bg: "–†–∞–¥–æ—Å—Ç", en: "Joy" }, icon: "üòä", cat: "place" },
            { id: 53, text: { bg: "–¢—ä–≥–∞", en: "Sadness" }, icon: "üò¢", cat: "place" },
            { id: 54, text: { bg: "–°—ä—Ä—Ü–µ", en: "Heart" }, icon: "‚ù§Ô∏è", cat: "place" },
            { id: 87, text: { bg: "–ì—Ä–∞–¥", en: "City" }, icon: "üèôÔ∏è", cat: "place" },
            { id: 88, text: { bg: "–§–µ—Ä–º–∞", en: "Farm" }, icon: "üöú", cat: "place" },
            { id: 89, text: { bg: "–ë–æ–ª–Ω–∏—Ü–∞", en: "Hospital" }, icon: "üè•", cat: "place" },
            { id: 90, text: { bg: "–¶–∏—Ä–∫", en: "Circus" }, icon: "üé™", cat: "place" },
            { id: 91, text: { bg: "–ü–µ—â–µ—Ä–∞", en: "Cave" }, icon: "üï≥Ô∏è", cat: "place" },
            { id: 92, text: { bg: "–í—É–ª–∫–∞–Ω", en: "Volcano" }, icon: "üåã", cat: "place" },
            { id: 93, text: { bg: "–ü–æ–¥ –≤–æ–¥–∞", en: "Underwater" }, icon: "ü™∏", cat: "place" },
             // ACTIONS
            { id: 55, text: { bg: "–¢–∏—á–∞", en: "Run" }, icon: "üèÉ", cat: "action" },
            { id: 56, text: { bg: "–°–ø–∏", en: "Sleep" }, icon: "üò¥", cat: "action" },
            { id: 57, text: { bg: "–Ø–¥–µ", en: "Eat" }, icon: "üçΩÔ∏è", cat: "action" },
            { id: 58, text: { bg: "–õ–µ—Ç–∏", en: "Fly" }, icon: "‚úàÔ∏è", cat: "action" },
            { id: 59, text: { bg: "–ü–ª—É–≤–∞", en: "Swim" }, icon: "üèä", cat: "action" },
            { id: 60, text: { bg: "–ß–µ—Ç–µ", en: "Read" }, icon: "üìñ", cat: "action" },
            { id: 61, text: { bg: "–†–∏—Å—É–≤–∞", en: "Paint" }, icon: "üé®", cat: "action" },
            { id: 62, text: { bg: "–ü–µ–µ", en: "Sing" }, icon: "üé§", cat: "action" },
            { id: 63, text: { bg: "–¢–∞–Ω—Ü—É–≤–∞", en: "Dance" }, icon: "üíÉ", cat: "action" },
            { id: 64, text: { bg: "–ò–≥—Ä–∞–µ", en: "Play" }, icon: "üéÆ", cat: "action" },
            { id: 65, text: { bg: "–¢—ä—Ä—Å–∏", en: "Search" }, icon: "üîç", cat: "action" },
            { id: 66, text: { bg: "–ì–æ—Ç–≤–∏", en: "Cook" }, icon: "üç≥", cat: "action" },
            { id: 67, text: { bg: "–ú–∏—Å–ª–∏", en: "Think" }, icon: "ü§î", cat: "action" },
            { id: 68, text: { bg: "–°–º–µ–µ —Å–µ", en: "Laugh" }, icon: "üòÇ", cat: "action" },
            { id: 69, text: { bg: "–ü–ª–∞—á–µ", en: "Cry" }, icon: "üò≠", cat: "action" },
            { id: 70, text: { bg: "–û–±–∏—á–∞", en: "Love" }, icon: "üòç", cat: "action" },
            { id: 71, text: { bg: "–°—Ç—Ä–æ–∏", en: "Build" }, icon: "üß±", cat: "action" },
            { id: 72, text: { bg: "–ö–∞—Ç–µ—Ä–∏ —Å–µ", en: "Climb" }, icon: "üßó", cat: "action" },
            { id: 94, text: { bg: "–ë–∏–µ —Å–µ", en: "Fight" }, icon: "‚öîÔ∏è", cat: "action" },
            { id: 95, text: { bg: "–®–æ—Ñ–∏—Ä–∞", en: "Drive" }, icon: "üöó", cat: "action" },
            { id: 96, text: { bg: "–ö—Ä–∏–µ —Å–µ", en: "Hide" }, icon: "ü´£", cat: "action" },
            { id: 97, text: { bg: "–ö—ä–ø–µ —Å–µ", en: "Bath" }, icon: "üõÅ", cat: "action" },
            { id: 98, text: { bg: "–ü–∞–∑–∞—Ä—É–≤–∞", en: "Shop" }, icon: "üõí", cat: "action" },
            { id: 99, text: { bg: "–ü–∏—à–µ", en: "Write" }, icon: "‚úçÔ∏è", cat: "action" },
            { id: 100, text: { bg: "–°–Ω–∏–º–∞", en: "Photo" }, icon: "üì∏", cat: "action" }
        ];

        let currentItems = [];
        let swapCounts = [];
        let lockedStates = [];
        let voices = [];
        let currentLang = 'bg';

        function saveSettings() {
            const settings = {
                lang: currentLang,
                darkMode: document.body.classList.contains('dark-mode'),
                count: document.getElementById('count-select').value,
                level: document.getElementById('level-select').value
            };
            localStorage.setItem('storyDiceSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('storyDiceSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                if (settings.lang) currentLang = settings.lang;
                document.querySelector('.lang-btn').textContent = currentLang.toUpperCase();
                
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.querySelector('.dark-btn').textContent = '‚òÄÔ∏è';
                }
                if (settings.count) document.getElementById('count-select').value = settings.count;
                if (settings.level) document.getElementById('level-select').value = settings.level;
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'bg' ? 'en' : 'bg';
            document.querySelector('.lang-btn').textContent = currentLang.toUpperCase();
            saveSettings();
            updateUI();
            updateCardsText();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const btn = document.querySelector('.dark-btn');
            btn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
            saveSettings();
        }

        function updateCardsText() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                const item = currentItems[index];
                if (item) card.querySelector('.card-text').textContent = item.text[currentLang];
            });
        }

        function updateUI() {
            const t = uiText[currentLang];
            document.getElementById('ui-title').textContent = t.title;
            document.getElementById('ui-hero').textContent = t.hero;
            document.getElementById('ui-item').textContent = t.item;
            document.getElementById('ui-place').textContent = t.place;
            document.getElementById('ui-action').textContent = t.action;
            document.getElementById('ui-save').textContent = t.save;
            document.getElementById('ui-roll').textContent = t.roll;
            document.getElementById('opt-beginner').textContent = t.optBeginner;
            document.getElementById('opt-advanced').textContent = t.optAdvanced;
            document.getElementById('opt-expert').textContent = t.optExpert;
            
            const level = document.getElementById('level-select').value;
            if(level === 'beginner') {
                document.getElementById('leg-action').classList.add('dimmed');
            } else {
                document.getElementById('leg-action').classList.remove('dimmed');
            }

            const modalContent = document.getElementById('modal-text-content');
            modalContent.innerHTML = `
                <h2>${t.modalTitle}</h2>
                ${t.modalSteps.map(s => `<p>${s}</p>`).join('')}
                <h3>${t.modalTipsTitle}</h3>
                <ul>${t.modalTips.map(tip => `<li>${tip}</li>`).join('')}</ul>
            `;
        }

        // --- TTS ---
        function initVoices() { voices = window.speechSynthesis.getVoices(); }
        if ('speechSynthesis' in window) { window.speechSynthesis.onvoiceschanged = initVoices; initVoices(); }

        function speak(textObj, cardElement) {
            if (!('speechSynthesis' in window)) return;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('speaking'));
            if(cardElement) {
                cardElement.classList.add('speaking');
                setTimeout(() => cardElement.classList.remove('speaking'), 1000);
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(textObj[currentLang]);
            if (voices.length === 0) voices = window.speechSynthesis.getVoices();
            utterance.lang = currentLang === 'bg' ? 'bg-BG' : 'en-US';
            window.speechSynthesis.speak(utterance);
        }

        // --- MODAL ---
        function openModal() { updateUI(); document.getElementById('infoModal').style.display = 'flex'; }
        function closeModal(event, force) {
            if (force || event.target.id === 'infoModal') document.getElementById('infoModal').style.display = 'none';
        }

        // --- LOGIC ---
        function shuffle(array) {
            let cur = array.length, rnd;
            const newArr = [...array];
            while (cur != 0) {
                rnd = Math.floor(Math.random() * cur);
                cur--;
                [newArr[cur], newArr[rnd]] = [newArr[rnd], newArr[cur]];
            }
            return newArr;
        }

        function rollAllWithAnimation() {
            const board = document.getElementById('game-board');
            if (board.children.length > 0) {
                Array.from(board.children).forEach((c, i) => {
                    if (!lockedStates[i]) c.classList.add('animate-shake');
                });
                setTimeout(rollAll, 300);
            } else {
                rollAll();
            }
        }

        function rollAll() {
            saveSettings();
            updateUI();

            const count = parseInt(document.getElementById('count-select').value);
            const level = document.getElementById('level-select').value;
            const board = document.getElementById('game-board');

            // --- –ú–û–ë–ò–õ–ù–ê –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ù–ê –ö–û–õ–û–ù–ò–¢–ï ---
            if(window.innerWidth < 768) {
                if(count >= 7) {
                    board.style.gridTemplateColumns = "repeat(3, 1fr)";
                } else {
                    board.style.gridTemplateColumns = "repeat(2, 1fr)";
                }
            } else {
                board.style.gridTemplateColumns = ""; 
            }

            if (currentItems.length !== count) {
                currentItems = new Array(count).fill(null);
                swapCounts = new Array(count).fill(0);
                lockedStates = new Array(count).fill(false);
                board.innerHTML = '';
            }

            const heroes = shuffle(db.filter(x => x.cat === 'hero'));
            const items = shuffle(db.filter(x => x.cat === 'item'));
            const places = shuffle(db.filter(x => x.cat === 'place'));
            const actions = shuffle(db.filter(x => x.cat === 'action'));

            let selectionPlan = [];

            // 1. BEGINNER
            if (level === 'beginner') {
                const cats3 = ['hero', 'item', 'place'];
                const rnd3 = () => cats3[Math.floor(Math.random() * cats3.length)];
                let limits = {hero:1, item:1, place:1}; 
                
                switch(count) {
                    case 3: limits = {hero:1, item:1, place:1}; break;
                    case 4: limits = {hero:1, item:1, place:1}; limits[rnd3()]++; break;
                    case 5: limits = {hero:2, item:2, place:2}; limits[rnd3()]--; break;
                    case 6: limits = {hero:2, item:2, place:2}; break;
                    case 7: limits = {hero:2, item:2, place:2}; limits[rnd3()]++; break;
                    case 8: limits = {hero:3, item:3, place:3}; limits[rnd3()]--; break;
                    case 9: limits = {hero:3, item:3, place:3}; break;
                    default: 
                         while(selectionPlan.length < count) selectionPlan.push(rnd3());
                }
                
                if(selectionPlan.length === 0) {
                    for(let k=0; k<limits.hero; k++) selectionPlan.push('hero');
                    for(let k=0; k<limits.item; k++) selectionPlan.push('item');
                    for(let k=0; k<limits.place; k++) selectionPlan.push('place');
                }
                selectionPlan = shuffle(selectionPlan);
            } 
            
            // 2. ADVANCED
            else if (level === 'advanced') {
                const cats4 = ['hero', 'action', 'item', 'place'];
                const rnd4 = () => cats4[Math.floor(Math.random() * cats4.length)];
                let limits = {hero:1, action:1, item:1, place:1};

                switch(count) {
                    case 3: limits = {hero:1, action:1, item:1, place:0}; break; 
                    case 4: limits = {hero:1, action:1, item:1, place:1}; break;
                    case 5: limits = {hero:1, action:1, item:1, place:1}; limits[rnd4()]++; break;
                    case 6: limits = {hero:1, action:1, item:1, place:1}; limits[rnd4()]++; limits[rnd4()]++; break; 
                    case 7: limits = {hero:2, action:2, item:2, place:2}; limits[rnd4()]--; break;
                    case 8: limits = {hero:2, action:2, item:2, place:2}; break;
                    case 9: limits = {hero:2, action:2, item:2, place:2}; limits[rnd4()]++; break;
                    default: 
                         while(selectionPlan.length < count) selectionPlan.push(rnd4());
                }

                 if(selectionPlan.length === 0) {
                    for(let k=0; k<limits.hero; k++) selectionPlan.push('hero');
                    for(let k=0; k<limits.action; k++) selectionPlan.push('action');
                    for(let k=0; k<limits.item; k++) selectionPlan.push('item');
                    for(let k=0; k<limits.place; k++) selectionPlan.push('place');
                }
                while(selectionPlan.length > count) selectionPlan.pop();
                while(selectionPlan.length < count) selectionPlan.push(rnd4());
                selectionPlan = shuffle(selectionPlan);
            }

            // 3. EXPERT
            else {
                const cats = ['hero', 'item', 'place', 'action'];
                for(let k=0; k<count; k++) {
                    selectionPlan.push(cats[Math.floor(Math.random() * cats.length)]);
                }
            }

            let newItems = [];
            let hI=0, iI=0, pI=0, aI=0;

            for (let i = 0; i < count; i++) {
                if (lockedStates[i] && currentItems[i]) {
                    newItems.push(currentItems[i]);
                } else {
                    swapCounts[i] = 0;
                    let category = selectionPlan[i] || 'hero';
                    let candidate;
                    if (category === 'hero') candidate = heroes[hI++];
                    else if (category === 'item') candidate = items[iI++];
                    else if (category === 'place') candidate = places[pI++];
                    else if (category === 'action') candidate = actions[aI++];
                    newItems.push(candidate);
                }
            }

            currentItems = newItems;
            board.innerHTML = '';
            currentItems.forEach((item, index) => createCardDOM(item, index));
        }

        function changeOne(index) {
            if (swapCounts[index] >= 2 || lockedStates[index]) return;
            const currentCard = currentItems[index];
            const visibleIds = currentItems.map(x => x.id);
            const available = db.filter(x => !visibleIds.includes(x.id) && x.cat === currentCard.cat);
            if(available.length === 0) return;

            swapCounts[index]++;
            const newItem = available[Math.floor(Math.random() * available.length)];
            currentItems[index] = newItem;

            const wrapper = document.createElement('div');
            createCardDOM(newItem, index, wrapper);
            document.getElementById('game-board').children[index].replaceWith(wrapper.firstElementChild);
        }

        function toggleLock(index) {
            lockedStates[index] = !lockedStates[index];
            const wrapper = document.createElement('div');
            createCardDOM(currentItems[index], index, wrapper);
            document.getElementById('game-board').children[index].replaceWith(wrapper.firstElementChild);
        }

        function createCardDOM(item, index, parent = document.getElementById('game-board')) {
            const card = document.createElement('div');
            const isLocked = lockedStates[index];
            card.className = `card cat-${item.cat} animate-pop ${isLocked ? 'locked' : ''}`;
            card.onclick = () => speak(item.text, card);

            const icon = document.createElement('div');
            icon.className = 'card-icon';
            icon.textContent = item.icon;
            const text = document.createElement('div');
            text.className = 'card-text';
            text.textContent = item.text[currentLang];

            const lockBtn = document.createElement('div');
            lockBtn.className = 'card-btn lock-btn';
            lockBtn.innerHTML = isLocked ? 'üîí' : 'üîì';
            lockBtn.onclick = (e) => { e.stopPropagation(); toggleLock(index); };
            card.appendChild(lockBtn);

            if (!isLocked && swapCounts[index] < 2) {
                const swapBtn = document.createElement('div');
                swapBtn.className = 'card-btn swap-btn';
                let dotsHTML = '<div class="swap-dots">';
                const remaining = 2 - swapCounts[index];
                for(let i=0; i<remaining; i++) {
                    dotsHTML += '<span class="swap-dot"></span>';
                }
                dotsHTML += '</div>';
                swapBtn.innerHTML = dotsHTML;
                swapBtn.onclick = (e) => { e.stopPropagation(); changeOne(index); };
                card.appendChild(swapBtn);
            }

            card.appendChild(icon);
            card.appendChild(text);
            parent.appendChild(card);
        }

        function takeScreenshot() {
            html2canvas(document.body).then(canvas => {
                const link = document.createElement('a');
                link.download = 'story-dice-' + Date.now() + '.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        window.onload = function() {
            loadSettings();
            if(!localStorage.getItem('storyDiceSettings')) document.getElementById('level-select').value = 'beginner';
            updateUI();
            rollAll();
        };
    </script>
</body>
</html>

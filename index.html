<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Story Dice / –ü—Ä–∏–∫–∞–∑–Ω–∏ –ó–∞—Ä—á–µ—Ç–∞</title>
    <style>
        :root {
            --bg-color: #f0f8ff;
            --card-bg: #ffffff;
            --primary-btn: #FF9800;
            --refresh-btn: #2196F3;

            --cat-hero-bg: #e8f5e9;
            --cat-hero-border: #4CAF50;
            --cat-item-bg: #fffde7;
            --cat-item-border: #FFC107;
            --cat-place-bg: #ffebee;
            --cat-place-border: #F44336;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        h1 {
            margin: 0 0 5px 0;
            font-size: 1.4rem;
            color: #ff5722;
            flex: 0 0 auto;
            padding: 0 35px; /* –ú—è—Å—Ç–æ –∑–∞ –±—É—Ç–æ–Ω–∏—Ç–µ */
            text-align: center;
        }

        /* --- –ë–£–¢–û–ù–ò –í –™–ì–õ–ò–¢–ï --- */
        .top-btn {
            position: absolute;
            top: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .lang-btn {
            left: 15px;
            background: white;
            color: #333;
            border: 2px solid #333;
        }

        .info-btn {
            right: 15px;
            background: #2196F3;
            color: white;
            font-size: 1.2rem;
        }

        /* --- –ú–û–î–ê–õ–ï–ù –ü–†–û–ó–û–†–ï–¶ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
            animation: fadeIn 0.3s;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }

        .modal h2 { color: #ff5722; margin-top: 0; }
        .modal h3 { color: #2196F3; margin-bottom: 5px; margin-top: 15px; }
        .modal p, .modal ul { font-size: 0.95rem; line-height: 1.5; color: #444; }
        .modal ul { padding-left: 20px; margin-top: 5px; }
        .modal li { margin-bottom: 5px; }

        /* --- LEGEND & CONTROLS --- */
        .legend-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
            font-size: 0.75rem;
            background: white;
            padding: 4px 10px;
            border-radius: 15px;
            flex: 0 0 auto;
        }

        .legend-item { display: flex; align-items: center; gap: 4px; font-weight: bold; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.hero { background: var(--cat-hero-border); }
        .dot.item { background: var(--cat-item-border); }
        .dot.place { background: var(--cat-place-border); }

        .controls { margin-bottom: 5px; flex: 0 0 auto; }
        select { font-size: 0.9rem; padding: 2px 8px; border-radius: 6px; border: 1px solid #ccc; }

        /* --- GAME BOARD --- */
        .game-board {
            flex: 1 1 auto;
            width: 100%;
            max-width: 600px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: minmax(0, 1fr);
            gap: 8px;
            padding: 5px 0;
            overflow-y: auto;
        }

        @media (min-width: 500px) { .game-board { grid-template-columns: 1fr 1fr 1fr; } }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            position: relative;
            border-bottom: 4px solid #ccc;
            cursor: pointer;
            height: 100%;
            max-height: 25vh;
        }

        .card:active { transform: scale(0.97); }
        .card.cat-hero { background: var(--cat-hero-bg); border-color: var(--cat-hero-border); }
        .card.cat-item { background: var(--cat-item-bg); border-color: var(--cat-item-border); }
        .card.cat-place { background: var(--cat-place-bg); border-color: var(--cat-place-border); }
        .card.speaking { outline: 3px solid #2196F3; }

        .card-icon { font-size: 2.5rem; line-height: 1; margin-bottom: 5px; }
        .card-text {
            font-size: 0.9rem; font-weight: bold; text-align: center; line-height: 1.1;
            width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .swap-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255,255,255,0.95);
            color: var(--refresh-btn);
            border: 2px solid var(--refresh-btn);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.4rem;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .main-action {
            flex: 0 0 auto;
            margin-top: 5px;
            background-color: var(--primary-btn);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 300px;
        }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px) rotate(-3deg); } 75% { transform: translateX(3px) rotate(3deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .animate-pop { animation: popIn 0.3s ease-out; }
        .animate-shake { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body>

    <button class="top-btn lang-btn" onclick="toggleLanguage()">BG</button>

    <button class="top-btn info-btn" onclick="openModal()">?</button>

    <h1 id="ui-title">–†–∞–∑–∫–∞–∂–∏ –ø—Ä–∏–∫–∞–∑–∫–∞</h1>

    <div class="legend-container">
        <div class="legend-item"><span class="dot hero"></span> <span id="ui-hero">–ì–µ—Ä–æ–π</span></div>
        <div class="legend-item"><span class="dot item"></span> <span id="ui-item">–ü—Ä–µ–¥–º–µ—Ç</span></div>
        <div class="legend-item"><span class="dot place"></span> <span id="ui-place">–ú—è—Å—Ç–æ</span></div>
    </div>

    <div class="controls">
        <label for="count-select" id="ui-count">–ë—Ä–æ–π:</label>
        <select id="count-select" onchange="rollAll()">
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
        </select>
    </div>

    <div id="game-board" class="game-board"></div>

    <button class="main-action" onclick="rollAllWithAnimation()">
        üé≤ <span id="ui-roll">–•–í–™–†–õ–ò –í–°–ò–ß–ö–ò</span>
    </button>

    <div id="infoModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal(event, true)">&times;</span>
            <div id="modal-text-content">
                </div>
        </div>
    </div>

    <script>
        // --- –î–ê–ù–ù–ò –ó–ê –ü–†–ï–í–û–î –ù–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        const uiText = {
            bg: {
                title: "–†–∞–∑–∫–∞–∂–∏ –ø—Ä–∏–∫–∞–∑–∫–∞",
                hero: "–ì–µ—Ä–æ–π", item: "–ü—Ä–µ–¥–º–µ—Ç", place: "–ú—è—Å—Ç–æ",
                count: "–ë—Ä–æ–π:",
                roll: "–•–í–™–†–õ–ò –í–°–ò–ß–ö–ò",
                modalTitle: "üìñ –ö–∞–∫ —Å–µ –∏–≥—Ä–∞–µ?",
                modalSteps: [
                    "1. –ò–∑–±–µ—Ä–µ—Ç–µ –±—Ä–æ—è –Ω–∞ –∫–∞—Ä—Ç–∏—Ç–µ.",
                    "2. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ <strong>'–•–≤—ä—Ä–ª–∏ –≤—Å–∏—á–∫–∏'</strong>.",
                    "3. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏—Ç–µ, –∑–∞ –¥–∞ —Å—ä—Å—Ç–∞–≤–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—è. –ó–∞–ø–æ—á–Ω–µ—Ç–µ —Å <em>'–ò–º–∞–ª–æ –µ–¥–Ω–æ –≤—Ä–µ–º–µ...'</em>"
                ],
                modalTipsTitle: "üí° –°—ä–≤–µ—Ç–∏ –∑–∞ —Ä–æ–¥–∏—Ç–µ–ª–∏:",
                modalTips: [
                    "<strong>–ù—è–º–∞ –≥—Ä–µ—à–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏!</strong> –û—Å—Ç–∞–≤–µ—Ç–µ –≤—ä–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –¥–∞ —Ä–∞–±–æ—Ç–∏.",
                    "<strong>–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤—ä–ø—Ä–æ—Å–∏:</strong> '–ó–∞—â–æ?', '–ö—ä–¥–µ?', '–ö–∞–∫–≤–æ —Å—Ç–∞–Ω–∞ –ø–æ—Å–ª–µ?'",
                    "<strong>–†–µ–¥—É–≤–∞–π—Ç–µ —Å–µ:</strong> –ï–¥–Ω–æ –∏–∑—Ä–µ—á–µ–Ω–∏–µ –æ—Ç –≤–∞—Å, –µ–¥–Ω–æ –æ—Ç –¥–µ—Ç–µ—Ç–æ.",
                    "<strong>–¶–≤–µ—Ç–æ–≤–µ:</strong> –ó–µ–ª–µ–Ω–æ = –ì–µ—Ä–æ–π, –ñ—ä–ª—Ç–æ = –ü—Ä–µ–¥–º–µ—Ç, –ß–µ—Ä–≤–µ–Ω–æ = –ú—è—Å—Ç–æ/–ß—É–≤—Å—Ç–≤–æ."
                ]
            },
            en: {
                title: "Story Dice",
                hero: "Hero", item: "Item", place: "Place",
                count: "Count:",
                roll: "ROLL ALL",
                modalTitle: "üìñ How to play?",
                modalSteps: [
                    "1. Select the number of cards.",
                    "2. Press <strong>'Roll All'</strong>.",
                    "3. Use the pictures to create a story. Start with <em>'Once upon a time...'</em>"
                ],
                modalTipsTitle: "üí° Tips for parents:",
                modalTips: [
                    "<strong>No wrong answers!</strong> Let imagination run wild.",
                    "<strong>Ask questions:</strong> 'Why?', 'Where?', 'What happened next?'",
                    "<strong>Take turns:</strong> You say one sentence, the child says the next.",
                    "<strong>Colors:</strong> Green = Hero, Yellow = Item, Red = Place/Mood."
                ]
            }
        };

        // --- –ù–û–í–ê –ë–ê–ó–ê –î–ê–ù–ù–ò (–ü–†–ï–í–ï–î–ï–ù–ê) ---
        const db = [
            // –ì–ï–†–û–ò (1-18)
            { id: 1, text: { bg: "–ú–æ–º—á–µ", en: "Boy" }, icon: "üë¶", cat: "hero" },
            { id: 2, text: { bg: "–ú–æ–º–∏—á–µ", en: "Girl" }, icon: "üëß", cat: "hero" },
            { id: 3, text: { bg: "–ë–µ–±–µ", en: "Baby" }, icon: "üë∂", cat: "hero" },
            { id: 4, text: { bg: "–î—è–¥–æ", en: "Grandfather" }, icon: "üë¥", cat: "hero" },
            { id: 5, text: { bg: "–°—É–ø–µ—Ä–≥–µ—Ä–æ–π", en: "Superhero" }, icon: "ü¶∏", cat: "hero" },
            { id: 6, text: { bg: "–ü–∏—Ä–∞—Ç", en: "Pirate" }, icon: "üè¥‚Äç‚ò†Ô∏è", cat: "hero" },
            { id: 7, text: { bg: "–ö—É—á–µ", en: "Dog" }, icon: "üê∂", cat: "hero" },
            { id: 8, text: { bg: "–ö–æ—Ç–∫–∞", en: "Cat" }, icon: "üê±", cat: "hero" },
            { id: 9, text: { bg: "–ó–∞–π—á–µ", en: "Bunny" }, icon: "üê∞", cat: "hero" },
            { id: 10, text: { bg: "–ü—Ç–∏—á–µ", en: "Bird" }, icon: "üê¶", cat: "hero" },
            { id: 11, text: { bg: "–ö–æ–Ω—á–µ", en: "Horse" }, icon: "üê¥", cat: "hero" },
            { id: 12, text: { bg: "–°–ª–æ–Ω—á–µ", en: "Elephant" }, icon: "üêò", cat: "hero" },
            { id: 13, text: { bg: "–î—Ä–∞–∫–æ–Ω", en: "Dragon" }, icon: "üê≤", cat: "hero" },
            { id: 14, text: { bg: "–î–∏–Ω–æ–∑–∞–≤—ä—Ä", en: "Dinosaur" }, icon: "ü¶ñ", cat: "hero" },
            { id: 15, text: { bg: "–†–æ–±–æ—Ç", en: "Robot" }, icon: "ü§ñ", cat: "hero" },
            { id: 16, text: { bg: "–ò–∑–≤—ä–Ω–∑–µ–º–Ω–æ", en: "Alien" }, icon: "üëΩ", cat: "hero" },
            { id: 17, text: { bg: "–§–µ—è", en: "Fairy" }, icon: "üßö", cat: "hero" },
            { id: 18, text: { bg: "–ß—É–¥–æ–≤–∏—â–µ", en: "Monster" }, icon: "üëæ", cat: "hero" },

            // –ü–†–ï–î–ú–ï–¢–ò (19-36)
            { id: 19, text: { bg: "–¢–æ–ø–∫–∞", en: "Ball" }, icon: "‚öΩ", cat: "item" },
            { id: 20, text: { bg: "–ú–µ—á–µ", en: "Teddy Bear" }, icon: "üß∏", cat: "item" },
            { id: 21, text: { bg: "–ö–æ–ª–∏—á–∫–∞", en: "Car" }, icon: "üöó", cat: "item" },
            { id: 22, text: { bg: "–ö–æ—Ä–æ–Ω–∞", en: "Crown" }, icon: "üëë", cat: "item" },
            { id: 23, text: { bg: "–ë–∞–ª–æ–Ω", en: "Balloon" }, icon: "üéà", cat: "item" },
            { id: 24, text: { bg: "–ö–Ω–∏–≥–∞", en: "Book" }, icon: "üìñ", cat: "item" },
            { id: 25, text: { bg: "–í—ä–ª—à–µ–±–Ω–∞ –ø—Ä—ä—á–∫–∞", en: "Magic Wand" }, icon: "ü™Ñ", cat: "item" },
            { id: 26, text: { bg: "–õ—ä–∂–∏—Ü–∞", en: "Spoon" }, icon: "ü•Ñ", cat: "item" },
            { id: 27, text: { bg: "–û–±—É–≤–∫–∏", en: "Shoes" }, icon: "üëü", cat: "item" },
            { id: 28, text: { bg: "–ö–ª—é—á", en: "Key" }, icon: "üîë", cat: "item" },
            { id: 29, text: { bg: "–§–µ–Ω–µ—Ä—á–µ", en: "Flashlight" }, icon: "üî¶", cat: "item" },
            { id: 30, text: { bg: "–ü–æ–¥–∞—Ä—ä–∫", en: "Gift" }, icon: "üéÅ", cat: "item" },
            { id: 31, text: { bg: "–ö–æ–ª–µ–ª–æ", en: "Bicycle" }, icon: "üö≤", cat: "item" },
            { id: 32, text: { bg: "–†–∞–∫–µ—Ç–∞", en: "Rocket" }, icon: "üöÄ", cat: "item" },
            { id: 33, text: { bg: "–õ–æ–¥–∫–∞", en: "Boat" }, icon: "‚õµ", cat: "item" },
            { id: 34, text: { bg: "–í–ª–∞–∫", en: "Train" }, icon: "üöÇ", cat: "item" },
            { id: 35, text: { bg: "–¢–æ—Ä—Ç–∞", en: "Cake" }, icon: "üéÇ", cat: "item" },
            { id: 36, text: { bg: "–°–ª–∞–¥–æ–ª–µ–¥", en: "Ice Cream" }, icon: "üç¶", cat: "item" },

            // –°–†–ï–î–ê –ò –ï–ú–û–¶–ò–ò (37-54)
            { id: 37, text: { bg: "–ö—ä—â–∞", en: "House" }, icon: "üè†", cat: "place" },
            { id: 38, text: { bg: "–£—á–∏–ª–∏—â–µ", en: "School" }, icon: "üè´", cat: "place" },
            { id: 39, text: { bg: "–ü—ä—Ä–∑–∞–ª–∫–∞", en: "Slide" }, icon: "üõù", cat: "place" },
            { id: 40, text: { bg: "–ì–æ—Ä–∞", en: "Forest" }, icon: "üå≤", cat: "place" },
            { id: 41, text: { bg: "–ü–ª–∞–∂", en: "Beach" }, icon: "üèñÔ∏è", cat: "place" },
            { id: 42, text: { bg: "–ö–æ—Å–º–æ—Å", en: "Space" }, icon: "ü™ê", cat: "place" },
            { id: 43, text: { bg: "–°–ª—ä–Ω—Ü–µ", en: "Sun" }, icon: "‚òÄÔ∏è", cat: "place" },
            { id: 44, text: { bg: "–õ—É–Ω–∞", en: "Moon" }, icon: "üåô", cat: "place" },
            { id: 45, text: { bg: "–î—ä–≥–∞", en: "Rainbow" }, icon: "üåà", cat: "place" },
            { id: 46, text: { bg: "–î—ä–∂–¥", en: "Rain" }, icon: "üåßÔ∏è", cat: "place" },
            { id: 47, text: { bg: "–°–Ω—è–≥", en: "Snow" }, icon: "‚ùÑÔ∏è", cat: "place" },
            { id: 48, text: { bg: "–¶–≤–µ—Ç–µ", en: "Flower" }, icon: "üå∏", cat: "place" },
            { id: 49, text: { bg: "–ó–∞–º—ä–∫", en: "Castle" }, icon: "üè∞", cat: "place" },
            { id: 50, text: { bg: "–û—Å—Ç—Ä–æ–≤", en: "Island" }, icon: "üèùÔ∏è", cat: "place" },
            { id: 51, text: { bg: "–õ–µ–≥–ª–æ", en: "Bed" }, icon: "üõèÔ∏è", cat: "place" },
            { id: 52, text: { bg: "–†–∞–¥–æ—Å—Ç", en: "Joy" }, icon: "üòä", cat: "place" },
            { id: 53, text: { bg: "–¢—ä–≥–∞", en: "Sadness" }, icon: "üò¢", cat: "place" },
            { id: 54, text: { bg: "–°—ä—Ä—Ü–µ", en: "Heart" }, icon: "‚ù§Ô∏è", cat: "place" }
        ];

        let currentItems = [];
        let voices = [];
        let currentLang = 'bg'; // 'bg' –∏–ª–∏ 'en'

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê –ï–ó–ò–ö–ê ---
        function toggleLanguage() {
            currentLang = currentLang === 'bg' ? 'en' : 'bg';
            document.querySelector('.lang-btn').textContent = currentLang.toUpperCase();

            updateUI();

            // –û–±–Ω–æ–≤—è–≤–∞–º–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–∏—Ç–µ –≤ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ, –±–µ–∑ –¥–∞ —Ö–≤—ä—Ä–ª—è–º–µ –Ω–æ–≤–∏
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                const item = currentItems[index];
                if (item) {
                    card.querySelector('.card-text').textContent = item.text[currentLang];
                }
            });
        }

        function updateUI() {
            const t = uiText[currentLang];
            document.getElementById('ui-title').textContent = t.title;
            document.getElementById('ui-hero').textContent = t.hero;
            document.getElementById('ui-item').textContent = t.item;
            document.getElementById('ui-place').textContent = t.place;
            document.getElementById('ui-count').textContent = t.count;
            document.getElementById('ui-roll').textContent = t.roll;

            // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –º–æ–¥–∞–ª–Ω–∏—è —Ç–µ–∫—Å—Ç
            const modalContent = document.getElementById('modal-text-content');
            modalContent.innerHTML = `
                <h2>${t.modalTitle}</h2>
                ${t.modalSteps.map(s => `<p>${s}</p>`).join('')}
                <h3>${t.modalTipsTitle}</h3>
                <ul>
                    ${t.modalTips.map(tip => `<li>${tip}</li>`).join('')}
                </ul>
                <p style="text-align:center; margin-top:15px; font-size:0.8rem; color:#888;">
                    ${currentLang === 'bg' ? '–ü—Ä–∏—è—Ç–Ω–∞ –∏–≥—Ä–∞!' : 'Have fun!'}
                </p>
            `;
        }

        // --- –ì–û–í–û–† –ò –ó–í–£–ö ---
        function initVoices() { voices = window.speechSynthesis.getVoices(); }
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = initVoices;
            initVoices();
        }

        function speak(textObj, cardElement) {
            if (!('speechSynthesis' in window)) return;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('speaking'));
            if(cardElement) {
                cardElement.classList.add('speaking');
                setTimeout(() => cardElement.classList.remove('speaking'), 1000);
            }
            window.speechSynthesis.cancel();

            // –ò–∑–±–∏—Ä–∞–º–µ –ø—Ä–∞–≤–∏–ª–Ω–∏—è –µ–∑–∏–∫ –∑–∞ –≥–æ–≤–æ—Ä
            const textToSpeak = textObj[currentLang];
            const utterance = new SpeechSynthesisUtterance(textToSpeak);

            // –û–ø–∏—Ç–≤–∞–º–µ —Å–µ –¥–∞ –Ω–∞–º–µ—Ä–∏–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ–Ω –≥–ª–∞—Å –∑–∞ –µ–∑–∏–∫–∞
            if (voices.length === 0) initVoices();

            const langCode = currentLang === 'bg' ? 'bg' : 'en';
            const specificVoice = voices.find(v => v.lang.toLowerCase().includes(langCode));

            if (specificVoice) utterance.voice = specificVoice;

            // Fallback –∞–∫–æ –Ω—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω –≥–ª–∞—Å, –∑–∞–¥–∞–≤–∞–º–µ –ø–æ–Ω–µ –∫–æ–¥–∞
            utterance.lang = currentLang === 'bg' ? 'bg-BG' : 'en-US';

            window.speechSynthesis.speak(utterance);
        }

        // --- –õ–û–ì–ò–ö–ê –ó–ê –ú–û–î–ê–õ–ù–ò–Ø –ü–†–û–ó–û–†–ï–¶ ---
        function openModal() {
            updateUI(); // –£–≤–µ—Ä—è–≤–∞–º–µ —Å–µ, —á–µ –µ –Ω–∞ –ø—Ä–∞–≤–∏–ª–Ω–∏—è –µ–∑–∏–∫
            document.getElementById('infoModal').style.display = 'flex';
        }

        function closeModal(event, force) {
            if (force || event.target.id === 'infoModal') {
                document.getElementById('infoModal').style.display = 'none';
            }
        }

        // --- –ò–ì–†–û–í–ê –õ–û–ì–ò–ö–ê ---
        function shuffle(array) {
            let cur = array.length, rnd;
            while (cur != 0) {
                rnd = Math.floor(Math.random() * cur);
                cur--;
                [array[cur], array[rnd]] = [array[rnd], array[cur]];
            }
            return array;
        }

        function rollAllWithAnimation() {
            const board = document.getElementById('game-board');
            if (board.children.length > 0) {
                Array.from(board.children).forEach(c => c.classList.add('animate-shake'));
                setTimeout(rollAll, 300);
            } else {
                rollAll();
            }
        }

        function rollAll() {
            const count = parseInt(document.getElementById('count-select').value);
            const board = document.getElementById('game-board');
            board.innerHTML = '';

            let selection = [];
            if (count >= 3) {
                selection.push(shuffle(db.filter(x => x.cat === 'hero'))[0]);
                selection.push(shuffle(db.filter(x => x.cat === 'item'))[0]);
                selection.push(shuffle(db.filter(x => x.cat === 'place'))[0]);
            }

            const usedIds = selection.map(x => x.id);
            const remaining = shuffle(db.filter(x => !usedIds.includes(x.id)));

            while (selection.length < count) {
                selection.push(remaining.pop());
            }

            currentItems = shuffle(selection);
            currentItems.forEach((item, index) => createCardDOM(item, index));
        }

        function changeOne(index) {
            const visibleIds = currentItems.map(x => x.id);
            const available = db.filter(x => !visibleIds.includes(x.id));
            if(available.length === 0) return;

            const newItem = available[Math.floor(Math.random() * available.length)];
            currentItems[index] = newItem;

            const wrapper = document.createElement('div');
            createCardDOM(newItem, index, wrapper);
            document.getElementById('game-board').children[index].replaceWith(wrapper.firstElementChild);
        }

        function createCardDOM(item, index, parent = document.getElementById('game-board')) {
            const card = document.createElement('div');
            card.className = `card cat-${item.cat} animate-pop`;
            card.onclick = () => speak(item.text, card);

            const icon = document.createElement('div');
            icon.className = 'card-icon';
            icon.textContent = item.icon;

            const text = document.createElement('div');
            text.className = 'card-text';
            text.textContent = item.text[currentLang]; // –ò–∑–±–∏—Ä–∞–º–µ –ø—Ä–∞–≤–∏–ª–Ω–∏—è –µ–∑–∏–∫

            const btn = document.createElement('div');
            btn.className = 'swap-btn';
            btn.innerHTML = '‚Üª';
            btn.onclick = (e) => { e.stopPropagation(); changeOne(index); };

            card.appendChild(btn);
            card.appendChild(icon);
            card.appendChild(text);
            parent.appendChild(card);
        }

        // –ü—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            updateUI();
            rollAll();
        };
    </script>
</body>
</html>

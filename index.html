<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü—Ä–∏–∫–∞–∑–Ω–∏ –ó–∞—Ä—á–µ—Ç–∞</title>
    <style>
        :root {
            --bg-color: #f0f8ff;
            --card-bg: #ffffff;
            --primary-btn: #FF9800;
            --refresh-btn: #2196F3;

            --cat-hero-bg: #e8f5e9;
            --cat-hero-border: #4CAF50;
            --cat-item-bg: #fffde7;
            --cat-item-border: #FFC107;
            --cat-place-bg: #ffebee;
            --cat-place-border: #F44336;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        h1 {
            margin: 0 0 5px 0;
            font-size: 1.4rem;
            color: #ff5722;
            flex: 0 0 auto;
            padding-right: 30px;
            text-align: center;
        }

        /* --- –ë–£–¢–û–ù –ó–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø --- */
        .info-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            border: none;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 200;
        }

        /* --- –ú–û–î–ê–õ–ï–ù –ü–†–û–ó–û–†–ï–¶ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: fadeIn 0.3s;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }

        .modal h2 { color: #ff5722; margin-top: 0; }
        .modal h3 { color: #2196F3; margin-bottom: 5px; margin-top: 15px; }
        .modal p, .modal ul { font-size: 0.95rem; line-height: 1.5; color: #444; }
        .modal ul { padding-left: 20px; margin-top: 5px; }

        /* --- LEGEND & CONTROLS --- */
        .legend-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 0.75rem;
            background: white;
            padding: 4px 10px;
            border-radius: 15px;
            flex: 0 0 auto;
        }

        .legend-item { display: flex; align-items: center; gap: 4px; font-weight: bold; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.hero { background: var(--cat-hero-border); }
        .dot.item { background: var(--cat-item-border); }
        .dot.place { background: var(--cat-place-border); }

        .controls {
            margin-bottom: 5px;
            flex: 0 0 auto;
        }

        select {
            font-size: 0.9rem;
            padding: 2px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        /* --- GAME BOARD --- */
        .game-board {
            flex: 1 1 auto;
            width: 100%;
            max-width: 600px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: minmax(0, 1fr);
            gap: 8px;
            padding: 5px 0;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        @media (min-width: 500px) {
            .game-board {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            position: relative;
            border-bottom: 4px solid #ccc;
            cursor: pointer;
            height: 100%;
            min-height: 110px;
        }

        .card:active { transform: scale(0.97); }

        .card.cat-hero { background: var(--cat-hero-bg); border-color: var(--cat-hero-border); }
        .card.cat-item { background: var(--cat-item-bg); border-color: var(--cat-item-border); }
        .card.cat-place { background: var(--cat-place-bg); border-color: var(--cat-place-border); }

        .card.speaking { outline: 3px solid #2196F3; }

        .card-icon {
            font-size: 2.5rem;
            line-height: 1;
            margin-bottom: 2px;
            margin-top: 10px;
        }

        .card-text {
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            line-height: 1.1;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* –ë–£–¢–û–ù –ó–ê –°–ú–Ø–ù–ê - –ì–û–†–ï –í–î–Ø–°–ù–û */
        .swap-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--refresh-btn);
            border: 2px solid var(--refresh-btn);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .swap-btn:active {
            background: var(--refresh-btn);
            color: white;
        }

        .main-action {
            flex: 0 0 auto;
            margin-top: 5px;
            background-color: var(--primary-btn);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 300px;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px) rotate(-3deg); }
            75% { transform: translateX(3px) rotate(3deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-pop { animation: popIn 0.3s ease-out; }
        .animate-shake { animation: shake 0.3s ease-in-out; }
    </style>
</head>

<body>

    <button class="info-btn" onclick="openModal()">?</button>

    <h1>‚ú® –†–∞–∑–∫–∞–∂–∏ –ø—Ä–∏–∫–∞–∑–∫–∞ ‚ú®</h1>

    <div class="legend-container">
        <div class="legend-item"><span class="dot hero"></span> –ì–µ—Ä–æ–π</div>
        <div class="legend-item"><span class="dot item"></span> –ü—Ä–µ–¥–º–µ—Ç</div>
        <div class="legend-item"><span class="dot place"></span> –ú—è—Å—Ç–æ/–û–±—Å—Ç–æ—è—Ç–µ–ª—Å—Ç–≤–æ</div>
    </div>

    <div class="controls">
        <label for="count-select">–ë—Ä–æ–π:</label>
        <select id="count-select" onchange="rollAll()">
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
        </select>
    </div>

    <div id="game-board" class="game-board"></div>

    <button class="main-action" onclick="rollAllWithAnimation()">
        –°–ú–ï–ù–ò –í–°–ò–ß–ö–ò
    </button>

    <div id="infoModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal(event, true)">&times;</span>
            <h2>üìñ –ö–∞–∫ —Å–µ –∏–≥—Ä–∞–µ?</h2>
            <p>1. –ò–∑–±–µ—Ä–µ—Ç–µ –±—Ä–æ—è –Ω–∞ –∫–∞—Ä—Ç–∏—Ç–µ.</p>
            <p>2. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ <strong>"–°–º–µ–Ω–∏ –≤—Å–∏—á–∫–∏"</strong>.</p>
            <p>3. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏—Ç–µ, –∑–∞ –¥–∞ —Å—ä—Å—Ç–∞–≤–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—è. –ó–∞–ø–æ—á–Ω–µ—Ç–µ —Å <em>"–ò–º–∞–ª–æ –µ–¥–Ω–æ –≤—Ä–µ–º–µ..."</em></p>
            <h3>üí° –°—ä–≤–µ—Ç–∏:</h3>
            <ul>
                <li>–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞—Ç–∞, –∑–∞ –¥–∞ —á—É–µ—Ç–µ –¥—É–º–∞—Ç–∞.</li>
                <li>–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ –º–∞–ª–∫–æ—Ç–æ –±—É—Ç–æ–Ω—á–µ ‚Üª, –∑–∞ –¥–∞ —Å–º–µ–Ω–∏—Ç–µ —Å–∞–º–æ —Ç–∞–∑–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞.</li>
                <li><strong>–ó–µ–ª–µ–Ω–æ</strong> = –ì–µ—Ä–æ–π, <strong>–ñ—ä–ª—Ç–æ</strong> = –ü—Ä–µ–¥–º–µ—Ç, <strong>–ß–µ—Ä–≤–µ–Ω–æ</strong> = –ú—è—Å—Ç–æ/–û–±—Å—Ç–æ—è—Ç–µ–ª—Å—Ç–≤–æ.</li>
            </ul>
        </div>
    </div>

    <script>
        // --- –õ–û–ì–ò–ö–ê –ó–ê –ú–û–î–ê–õ–ù–ò–Ø –ü–†–û–ó–û–†–ï–¶ ---
        function openModal() {
            document.getElementById('infoModal').style.display = 'flex';
        }

        function closeModal(event, force) {
            if (force || event.target.id === 'infoModal') {
                document.getElementById('infoModal').style.display = 'none';
            }
        }

        // --- –î–ê–ù–ù–ò ---
        const db = [
            // –ì–ï–†–û–ò (18)
            { id: 1, text: "–ú–æ–º—á–µ", icon: "üë¶", cat: "hero" },
            { id: 2, text: "–ú–æ–º–∏—á–µ", icon: "üëß", cat: "hero" },
            { id: 3, text: "–ë–µ–±–µ", icon: "üë∂", cat: "hero" },
            { id: 4, text: "–î—è–¥–æ", icon: "üë¥", cat: "hero" },
            { id: 5, text: "–°—É–ø–µ—Ä–≥–µ—Ä–æ–π", icon: "ü¶∏", cat: "hero" },
            { id: 6, text: "–ü–∏—Ä–∞—Ç", icon: "üè¥‚Äç‚ò†Ô∏è", cat: "hero" },
            { id: 7, text: "–ö—É—á–µ", icon: "üê∂", cat: "hero" },
            { id: 8, text: "–ö–æ—Ç–∫–∞", icon: "üê±", cat: "hero" },
            { id: 9, text: "–ó–∞–π—á–µ", icon: "üê∞", cat: "hero" },
            { id: 10, text: "–ü—Ç–∏—á–µ", icon: "üê¶", cat: "hero" },
            { id: 11, text: "–ö–æ–Ω—á–µ", icon: "üê¥", cat: "hero" },
            { id: 12, text: "–°–ª–æ–Ω—á–µ", icon: "üêò", cat: "hero" },
            { id: 13, text: "–î—Ä–∞–∫–æ–Ω", icon: "üê≤", cat: "hero" },
            { id: 14, text: "–î–∏–Ω–æ–∑–∞–≤—ä—Ä", icon: "ü¶ñ", cat: "hero" },
            { id: 15, text: "–†–æ–±–æ—Ç", icon: "ü§ñ", cat: "hero" },
            { id: 16, text: "–ò–∑–≤—ä–Ω–∑–µ–º–Ω–æ", icon: "üëΩ", cat: "hero" },
            { id: 17, text: "–§–µ—è", icon: "üßö", cat: "hero" },
            { id: 18, text: "–ß—É–¥–æ–≤–∏—â–µ", icon: "üëæ", cat: "hero" },

            // –ü–†–ï–î–ú–ï–¢–ò (18)
            { id: 19, text: "–¢–æ–ø–∫–∞", icon: "‚öΩ", cat: "item" },
            { id: 20, text: "–ú–µ—á–µ", icon: "üß∏", cat: "item" },
            { id: 21, text: "–ö–æ–ª–∏—á–∫–∞", icon: "üöó", cat: "item" },
            { id: 22, text: "–ö–æ—Ä–æ–Ω–∞", icon: "üëë", cat: "item" },
            { id: 23, text: "–ë–∞–ª–æ–Ω", icon: "üéà", cat: "item" },
            { id: 24, text: "–ö–Ω–∏–≥–∞", icon: "üìñ", cat: "item" },
            { id: 25, text: "–í—ä–ª—à–µ–±–Ω–∞ –ø—Ä—ä—á–∫–∞", icon: "ü™Ñ", cat: "item" },
            { id: 26, text: "–õ—ä–∂–∏—Ü–∞", icon: "ü•Ñ", cat: "item" },
            { id: 27, text: "–û–±—É–≤–∫–∏", icon: "üëü", cat: "item" },
            { id: 28, text: "–ö–ª—é—á", icon: "üîë", cat: "item" },
            { id: 29, text: "–§–µ–Ω–µ—Ä—á–µ", icon: "üî¶", cat: "item" },
            { id: 30, text: "–ü–æ–¥–∞—Ä—ä–∫", icon: "üéÅ", cat: "item" },
            { id: 31, text: "–ö–æ–ª–µ–ª–æ", icon: "üö≤", cat: "item" },
            { id: 32, text: "–†–∞–∫–µ—Ç–∞", icon: "üöÄ", cat: "item" },
            { id: 33, text: "–õ–æ–¥–∫–∞", icon: "‚õµ", cat: "item" },
            { id: 34, text: "–í–ª–∞–∫", icon: "üöÇ", cat: "item" },
            { id: 35, text: "–¢–æ—Ä—Ç–∞", icon: "üéÇ", cat: "item" },
            { id: 36, text: "–°–ª–∞–¥–æ–ª–µ–¥", icon: "üç¶", cat: "item" },

            // –°–†–ï–î–ê –ò –ï–ú–û–¶–ò–ò (18)
            { id: 37, text: "–ö—ä—â–∞", icon: "üè†", cat: "place" },
            { id: 38, text: "–£—á–∏–ª–∏—â–µ", icon: "üè´", cat: "place" },
            { id: 39, text: "–ü—ä—Ä–∑–∞–ª–∫–∞", icon: "üõù", cat: "place" },
            { id: 40, text: "–ì–æ—Ä–∞", icon: "üå≤", cat: "place" },
            { id: 41, text: "–ü–ª–∞–∂", icon: "üèñÔ∏è", cat: "place" },
            { id: 42, text: "–ö–æ—Å–º–æ—Å", icon: "ü™ê", cat: "place" },
            { id: 43, text: "–°–ª—ä–Ω—Ü–µ", icon: "‚òÄÔ∏è", cat: "place" },
            { id: 44, text: "–õ—É–Ω–∞", icon: "üåô", cat: "place" },
            { id: 45, text: "–î—ä–≥–∞", icon: "üåà", cat: "place" },
            { id: 46, text: "–î—ä–∂–¥", icon: "üåßÔ∏è", cat: "place" },
            { id: 47, text: "–°–Ω—è–≥", icon: "‚ùÑÔ∏è", cat: "place" },
            { id: 48, text: "–¶–≤–µ—Ç–µ", icon: "üå∏", cat: "place" },
            { id: 49, text: "–ó–∞–º—ä–∫", icon: "üè∞", cat: "place" },
            { id: 50, text: "–û—Å—Ç—Ä–æ–≤", icon: "üèùÔ∏è", cat: "place" },
            { id: 51, text: "–õ–µ–≥–ª–æ", icon: "üõèÔ∏è", cat: "place" },
            { id: 52, text: "–†–∞–¥–æ—Å—Ç", icon: "üòä", cat: "place" },
            { id: 53, text: "–¢—ä–≥–∞", icon: "üò¢", cat: "place" },
            { id: 54, text: "–°—ä—Ä—Ü–µ", icon: "‚ù§Ô∏è", cat: "place" }
        ];

        let currentItems = [];
        let voices = [];

        function initVoices() { voices = window.speechSynthesis.getVoices(); }
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = initVoices;
            initVoices();
        }

        function speak(text, cardElement) {
            if (!('speechSynthesis' in window)) return;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('speaking'));
            if (cardElement) {
                cardElement.classList.add('speaking');
                setTimeout(() => cardElement.classList.remove('speaking'), 1000);
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const bgVoice = voices.find(v => v.lang.includes('bg'));
            if (bgVoice) utterance.voice = bgVoice;
            utterance.lang = 'bg-BG';
            window.speechSynthesis.speak(utterance);
        }

        function shuffle(array) {
            let cur = array.length, rnd;
            while (cur != 0) {
                rnd = Math.floor(Math.random() * cur);
                cur--;
                [array[cur], array[rnd]] = [array[rnd], array[cur]];
            }
            return array;
        }

        function rollAllWithAnimation() {
            const board = document.getElementById('game-board');
            if (board.children.length > 0) {
                Array.from(board.children).forEach(c => c.classList.add('animate-shake'));
                setTimeout(rollAll, 300);
            } else {
                rollAll();
            }
        }

        function rollAll() {
            const count = parseInt(document.getElementById('count-select').value);
            const board = document.getElementById('game-board');
            board.innerHTML = '';

            // --- –ù–û–í–ê –õ–û–ì–ò–ö–ê –ó–ê –ë–ê–õ–ê–ù–° ---
            // –î–µ—Ñ–∏–Ω–∏—Ä–∞–º–µ —Å—Ö–µ–º–∏—Ç–µ –∑–∞ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –±—Ä–æ–π–∫–∏—Ç–µ
            let counts = []; // –©–µ —Å—ä—Ö—Ä–∞–Ω—è–≤–∞ 3 —á–∏—Å–ª–∞, –Ω–∞–ø—Ä. [2, 1, 1] –∑–∞ 4 –∫–∞—Ä—Ç–∏

            switch(count) {
                case 3: counts = [1, 1, 1]; break;
                case 4: counts = [2, 1, 1]; break;
                case 5: counts = [1, 2, 2]; break; // 1 —É–Ω–∏–∫–∞–ª–µ–Ω, –¥—Ä—É–≥–∏—Ç–µ –ø–æ 2
                case 6: counts = [2, 2, 2]; break;
                case 7: counts = [3, 2, 2]; break;
                case 8: counts = [2, 3, 3]; break; // 2 –æ—Ç –µ–¥–∏–Ω —Ü–≤—è—Ç, –¥—Ä—É–≥–∏—Ç–µ –ø–æ 3
                case 9: counts = [3, 3, 3]; break;
                default: counts = [1, 1, 1];
            }

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏—Ç–µ
            let categories = ['hero', 'item', 'place'];

            // –†–∞–∑–±—ä—Ä–∫–≤–∞–º–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏—Ç–µ, –∑–∞ –¥–∞ –Ω–µ –µ –≤–∏–Ω–∞–≥–∏ "hero" —Ç–æ–∑–∏ —Å –Ω–∞–π-–º–Ω–æ–≥–æ/–Ω–∞–π-–º–∞–ª–∫–æ –∫–∞—Ä—Ç–∏
            categories = shuffle(categories);

            let selection = [];

            // –ó–∞ –≤—Å—è–∫–∞ –æ—Ç 3-—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ–≥–ª–∏–º –Ω—É–∂–Ω–∏—è –±—Ä–æ–π –∫–∞—Ä—Ç–∏
            for (let i = 0; i < 3; i++) {
                const catName = categories[i];
                const numNeeded = counts[i];

                if (numNeeded > 0) {
                    const pool = db.filter(x => x.cat === catName);
                    const shuffledPool = shuffle([...pool]); // –ö–æ–ø–∏—Ä–∞–º–µ –∏ —Ä–∞–∑–±—ä—Ä–∫–≤–∞–º–µ
                    const chosen = shuffledPool.slice(0, numNeeded);
                    selection = selection.concat(chosen);
                }
            }

            // –ù–∞–∫—Ä–∞—è —Ä–∞–∑–±—ä—Ä–∫–≤–∞–º–µ —Ü–µ–ª–∏—è –∏–∑–±–æ—Ä, –∑–∞ –¥–∞ –Ω–µ —Å–∞ –ø–æ–¥—Ä–µ–¥–µ–Ω–∏ –ø–æ —Ü–≤—è—Ç
            currentItems = shuffle(selection);

            currentItems.forEach((item, index) => createCardDOM(item, index));
        }

        function changeOne(index) {
            const currentItem = currentItems[index];
            const currentCat = currentItem.cat;

            const catPool = db.filter(x => x.cat === currentCat);
            const visibleIds = currentItems.map(x => x.id);
            const available = catPool.filter(x => !visibleIds.includes(x.id));

            if (available.length === 0) return;

            const newItem = available[Math.floor(Math.random() * available.length)];
            currentItems[index] = newItem;

            const wrapper = document.createElement('div');
            createCardDOM(newItem, index, wrapper);
            document.getElementById('game-board').children[index].replaceWith(wrapper.firstElementChild);
        }

        function createCardDOM(item, index, parent = document.getElementById('game-board')) {
            const card = document.createElement('div');
            card.className = `card cat-${item.cat} animate-pop`;
            card.onclick = () => speak(item.text, card);

            const icon = document.createElement('div');
            icon.className = 'card-icon';
            icon.textContent = item.icon;

            const text = document.createElement('div');
            text.className = 'card-text';
            text.textContent = item.text;

            const btn = document.createElement('div');
            btn.className = 'swap-btn';
            btn.innerHTML = '‚Üª';
            btn.onclick = (e) => { e.stopPropagation(); changeOne(index); };

            card.appendChild(btn);
            card.appendChild(icon);
            card.appendChild(text);
            parent.appendChild(card);
        }

        window.onload = rollAll;
    </script>
</body>

</html>

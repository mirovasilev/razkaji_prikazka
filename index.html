<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Story Dice Ultimate</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            /* –ñ–∏–≤–∏ —Ü–≤–µ—Ç–æ–≤–µ –∑–∞ —Å–≤–µ—Ç—ä–ª —Ä–µ–∂–∏–º */
            --bg-gradient-1: #e0f7fa;
            --bg-gradient-2: #e1bee7;
            --bg-gradient-3: #fff9c4;

            --text-color: #000000;
            --card-bg: #ffffff;
            --primary-btn: #FF9800;
            --secondary-btn: #4CAF50;
            --refresh-btn: #2196F3;
            --lock-btn: #E91E63;
            --modal-bg: #ffffff;
            --modal-text: #444;

            --cat-hero-bg: #e8f5e9; --cat-hero-border: #4CAF50;
            --cat-item-bg: #fffde7; --cat-item-border: #FFC107;
            --cat-place-bg: #ffebee; --cat-place-border: #F44336;
            --cat-action-bg: #e3f2fd; --cat-action-border: #2196F3;
        }

        /* --- –ù–û–©–ï–ù –†–ï–ñ–ò–ú --- */
        body.dark-mode {
            --bg-gradient-1: #0f2027;
            --bg-gradient-2: #203a43;
            --bg-gradient-3: #2c5364;

            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --modal-bg: #1e1e1e;
            --modal-text: #ccc;

            --cat-hero-bg: #1b3320; --cat-hero-border: #2e7d32;
            --cat-item-bg: #332f00; --cat-item-border: #fbc02d;
            --cat-place-bg: #3e1a1a; --cat-place-border: #d32f2f;
            --cat-action-bg: #0d2740; --cat-action-border: #1565c0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Verdana', sans-serif;
            background: linear-gradient(-45deg, var(--bg-gradient-1), var(--bg-gradient-2), var(--bg-gradient-3));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-color);
            margin: 0; padding: 10px;
            height: 100dvh;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; position: relative;
            transition: color 0.3s;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1 {
            margin: 0 0 5px 0; font-size: 1.3rem; color: #ff5722;
            flex: 0 0 auto; padding: 0 40px; text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* --- –ë–£–¢–û–ù–ò –í –™–ì–õ–ò–¢–ï --- */
        .top-btn {
            position: absolute; top: 10px; width: 32px; height: 32px;
            border-radius: 50%; border: none; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 200;
            display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
            transition: transform 0.1s;
        }
        .top-btn:active { transform: scale(0.9); }
        .lang-btn { left: 10px; background: white; color: #333; border: 2px solid #333; }
        .dark-btn { left: 50px; background: #333; color: #fff; border: 2px solid #555; }
        body.dark-mode .dark-btn { background: #fff; color: #333; }
        .info-btn { right: 10px; background: var(--refresh-btn); color: white; font-size: 1.2rem; }

        /* --- LEGEND & CONTROLS --- */
        .legend-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
            margin-bottom: 5px; font-size: 0.75rem;
            background: var(--card-bg);
            padding: 5px 10px; border-radius: 15px; flex: 0 0 auto;
            color: var(--text-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .legend-item { display: flex; align-items: center; gap: 4px; font-weight: bold; white-space: nowrap; transition: opacity 0.3s; }
        .legend-item.dimmed { opacity: 0.3; text-decoration: line-through; }

        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.hero { background: var(--cat-hero-border); }
        .dot.item { background: var(--cat-item-border); }
        .dot.place { background: var(--cat-place-border); }
        .dot.action { background: var(--cat-action-border); }

        .controls { margin-bottom: 5px; flex: 0 0 auto; z-index: 10; display: flex; gap: 10px; }
        select {
            font-size: 1rem; padding: 4px 8px; border-radius: 8px;
            border: 2px solid var(--primary-btn);
            background: var(--card-bg);
            color: var(--text-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- GAME BOARD --- */
        .game-board {
            flex: 1 1 auto; width: 100%; max-width: 900px;
            display: grid; grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: minmax(120px, 1fr); gap: 8px;
            padding: 5px; overflow-y: auto;
            scrollbar-width: none;
        }
        .game-board::-webkit-scrollbar { display: none; }

        @media (min-width: 500px) { .game-board { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .game-board { grid-template-columns: repeat(4, 1fr); } }

        .card {
            background-color: var(--card-bg); border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px; position: relative;
            border-bottom: 5px solid #ccc; cursor: pointer;
            height: 100%; min-height: 0;
            transition: transform 0.1s;
        }
        .card:active { transform: scale(0.98); }

        .card.cat-hero { background: var(--cat-hero-bg); border-color: var(--cat-hero-border); }
        .card.cat-item { background: var(--cat-item-bg); border-color: var(--cat-item-border); }
        .card.cat-place { background: var(--cat-place-bg); border-color: var(--cat-place-border); }
        .card.cat-action { background: var(--cat-action-bg); border-color: var(--cat-action-border); }

        .card.speaking { outline: 3px solid var(--refresh-btn); }
        .card.locked { opacity: 0.9; border-style: dashed; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px); }

        .card-icon { font-size: 3rem; line-height: 1; margin-bottom: 8px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .card-text {
            font-size: 0.95rem; font-weight: 800; text-align: center; line-height: 1.1;
            width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: var(--text-color);
        }

        /* --- –ë–£–¢–û–ù–ò –í–™–†–•–£ –ö–ê–†–¢–ê–¢–ê --- */
        .card-btn {
            position: absolute; width: 32px; height: 32px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 5; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            font-size: 1.2rem; background: rgba(255,255,255,0.9);
            transition: all 0.2s;
        }
        body.dark-mode .card-btn { background: rgba(50,50,50,0.9); }
        .card-btn:active { transform: scale(0.9); }

        .swap-btn { top: 4px; right: 4px; color: var(--refresh-btn); border: 2px solid var(--refresh-btn); flex-direction: row; gap: 2px; padding: 0 4px; width: auto; min-width: 32px; }
        .swap-dots { display: flex; gap: 2px; }
        .swap-dot { display: inline-block; width: 6px; height: 6px; background: var(--refresh-btn); border-radius: 50%; }

        .lock-btn { top: 4px; left: 4px; color: #ccc; border: 2px solid #ccc; font-size: 1rem; }
        .card.locked .lock-btn { color: var(--lock-btn); border-color: var(--lock-btn); background: var(--card-bg); }

        /* --- –î–û–õ–ù–ò –ë–£–¢–û–ù–ò --- */
        .actions-container { flex: 0 0 auto; margin-top: 10px; display: flex; gap: 10px; width: 95%; max-width: 400px; justify-content: center; }
        .action-btn {
            border: none; padding: 12px; font-size: 1rem; font-weight: bold;
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            color: white; flex: 1;
        }
        .roll-btn { background-color: var(--primary-btn); flex: 2; font-size: 1.1rem; }
        .save-btn { background-color: var(--secondary-btn); flex: 1; }

        /* --- –ú–û–î–ê–õ --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); align-items: center; justify-content: center; }
        .modal-content {
            background-color: var(--modal-bg); color: var(--modal-text);
            margin: 20px; padding: 25px; border-radius: 20px;
            width: 90%; max-width: 500px; max-height: 85vh;
            overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative; animation: fadeIn 0.3s;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 2rem; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        .modal h2 { color: #ff5722; margin-top: 0; } .modal h3 { color: #2196F3; margin: 15px 0 5px; }
        .modal p, .modal li { font-size: 0.95rem; line-height: 1.6; margin-bottom: 8px; }
        .modal ul { padding-left: 25px; margin-top: 5px; }

        @keyframes popIn { 0% { transform: scale(0.6); opacity: 0; } 60% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px) rotate(-4deg); } 75% { transform: translateX(4px) rotate(4deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        /* --- –ü–û–ü–†–ê–í–ö–ê –ó–ê –õ–ê–ü–¢–û–ü --- */
        @media (min-width: 1024px) {
            .game-board { align-content: center; justify-items: center; grid-auto-rows: min-content; gap: 15px; }
            .card { height: auto; aspect-ratio: 9 / 14; width: 100%; max-width: 220px; margin: 0 auto; }
            .card-icon { font-size: 4rem; margin-bottom: 15px; }
            .card-text { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

    <button class="top-btn lang-btn" onclick="toggleLanguage()">BG</button>
    <button class="top-btn dark-btn" onclick="toggleDarkMode()">üåô</button>
    <button class="top-btn info-btn" onclick="openModal()">?</button>

    <h1 id="ui-title">–†–∞–∑–∫–∞–∂–∏ –ø—Ä–∏–∫–∞–∑–∫–∞</h1>

    <div class="legend-container">
        <div class="legend-item" id="leg-hero"><span class="dot hero"></span> <span id="ui-hero">–ì–µ—Ä–æ–π</span></div>
        <div class="legend-item" id="leg-action"><span class="dot action"></span> <span id="ui-action">–î–µ–π—Å—Ç–≤–∏–µ</span></div>
        <div class="legend-item" id="leg-item"><span class="dot item"></span> <span id="ui-item">–ü—Ä–µ–¥–º–µ—Ç</span></div>
        <div class="legend-item" id="leg-place"><span class="dot place"></span> <span id="ui-place">–ú—è—Å—Ç–æ</span></div>
    </div>

    <div class="controls">
        <select id="level-select" onchange="rollAll()">
            <option value="beginner" id="opt-beginner">–ù–∞—á–∏–Ω–∞–µ—â (3)</option>
            <option value="advanced" id="opt-advanced">–ù–∞–ø—Ä–µ–¥–Ω–∞–ª (4)</option>
            <option value="expert" id="opt-expert">–ï–∫—Å–ø–µ—Ä—Ç (Chaos)</option>
        </select>

        <select id="count-select" onchange="rollAll()">
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
        </select>
    </div>

    <div id="game-board" class="game-board"></div>

    <div class="actions-container">
        <button class="action-btn save-btn" onclick="takeScreenshot()">
            üì∏ <span id="ui-save">–ó–∞–ø–∞–∑–∏</span>
        </button>
        <button class="action-btn roll-btn" onclick="rollAllWithAnimation()">
            üé≤ <span id="ui-roll">–•–í–™–†–õ–ò –í–°–ò–ß–ö–ò</span>
        </button>
    </div>

    <div id="infoModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal(event, true)">&times;</span>
            <div id="modal-text-content"></div>
        </div>
    </div>

    <script>
        // --- –î–ê–ù–ù–ò ---
        const uiText = {
            bg: {
                title: "–†–∞–∑–∫–∞–∂–∏ –ø—Ä–∏–∫–∞–∑–∫–∞",
                hero: "–ì–µ—Ä–æ–π", item: "–ü—Ä–µ–¥–º–µ—Ç", place: "–ú—è—Å—Ç–æ", action: "–î–µ–π—Å—Ç–≤–∏–µ",
                optBeginner: "–ù–∞—á–∏–Ω–∞–µ—â (3)", optAdvanced: "–ù–∞–ø—Ä–µ–¥–Ω–∞–ª (4)", optExpert: "–ï–∫—Å–ø–µ—Ä—Ç (–ú–∏–∫—Å)",
                save: "–ó–∞–ø–∞–∑–∏", roll: "–•–í–™–†–õ–ò",
                modalTitle: "üìñ –ö–∞–∫ —Å–µ –∏–≥—Ä–∞–µ?",
                modalSteps: ["1. –ò–∑–±–µ—Ä–µ—Ç–µ –Ω–∏–≤–æ (–ù–∞—á–∏–Ω–∞–µ—â/–ù–∞–ø—Ä–µ–¥–Ω–∞–ª).", "2. –ò–∑–±–µ—Ä–µ—Ç–µ –±—Ä–æ–π –∫–∞—Ä—Ç–∏.", "3. –•–≤—ä—Ä–ª–µ—Ç–µ –∏ —Å—ä—á–∏–Ω–µ—Ç–µ –∏—Å—Ç–æ—Ä–∏—è!"],
                modalTipsTitle: "üí° –ù–∏–≤–∞:",
                modalTips: [
                    "<strong>–ù–∞—á–∏–Ω–∞–µ—â:</strong> –°–∞–º–æ –ì–µ—Ä–æ–π, –ü—Ä–µ–¥–º–µ—Ç –∏ –ú—è—Å—Ç–æ (–õ–µ—Å–Ω–æ).",
                    "<strong>–ù–∞–ø—Ä–µ–¥–Ω–∞–ª:</strong> –í–∫–ª—é—á–≤–∞ –∏ –î–µ–π—Å—Ç–≤–∏–µ (–ó–∞ –∏–∑—Ä–µ—á–µ–Ω–∏—è).",
                    "<strong>–ï–∫—Å–ø–µ—Ä—Ç:</strong> –ü—ä–ª–µ–Ω —Ö–∞–æ—Å –∑–∞ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç."
                ]
            },
            en: {
                title: "Story Dice",
                hero: "Hero", item: "Item", place: "Place", action: "Action",
                optBeginner: "Beginner (3)", optAdvanced: "Advanced (4)", optExpert: "Expert (Mix)",
                save: "Save", roll: "ROLL",
                modalTitle: "üìñ How to play?",
                modalSteps: ["1. Select level (Beginner/Advanced).", "2. Select count.", "3. Roll and tell a story!"],
                modalTipsTitle: "üí° Levels:",
                modalTips: [
                    "<strong>Beginner:</strong> Hero, Item, Place (Easy).",
                    "<strong>Advanced:</strong> Includes Action (For sentences).",
                    "<strong>Expert:</strong> Full random mix."
                ]
            }
        };

        // --- –ë–ê–ó–ê –î–ê–ù–ù–ò (100 –ö–ê–†–¢–ò) ---
        const db = [
            // HEROES (1-25)
            { id: 1, text: { bg: "–ú–æ–º—á–µ", en: "Boy" }, icon: "üë¶", cat: "hero" },
            { id: 2, text: { bg: "–ú–æ–º–∏—á–µ", en: "Girl" }, icon: "üëß", cat: "hero" },
            { id: 3, text: { bg: "–ë–µ–±–µ", en: "Baby" }, icon: "üë∂", cat: "hero" },
            { id: 4, text: { bg: "–î—è–¥–æ", en: "Grandfather" }, icon: "üë¥", cat: "hero" },
            { id: 5, text: { bg: "–°—É–ø–µ—Ä–≥–µ—Ä–æ–π", en: "Superhero" }, icon: "ü¶∏", cat: "hero" },
            { id: 6, text: { bg: "–ü–∏—Ä–∞—Ç", en: "Pirate" }, icon: "üè¥‚Äç‚ò†Ô∏è", cat: "hero" },
            { id: 7, text: { bg: "–ö—É—á–µ", en: "Dog" }, icon: "üê∂", cat: "hero" },
            { id: 8, text: { bg: "–ö–æ—Ç–∫–∞", en: "Cat" }, icon: "üê±", cat: "hero" },
            { id: 9, text: { bg: "–ó–∞–π—á–µ", en: "Bunny" }, icon: "üê∞", cat: "hero" },
            { id: 10, text: { bg: "–ü—Ç–∏—á–µ", en: "Bird" }, icon: "üê¶", cat: "hero" },
            { id: 11, text: { bg: "–ö–æ–Ω—á–µ", en: "Horse" }, icon: "üê¥", cat: "hero" },
            { id: 12, text: { bg: "–°–ª–æ–Ω—á–µ", en: "Elephant" }, icon: "üêò", cat: "hero" },
            { id: 13, text: { bg: "–î—Ä–∞–∫–æ–Ω", en: "Dragon" }, icon: "üê≤", cat: "hero" },
            { id: 14, text: { bg: "–î–∏–Ω–æ–∑–∞–≤—ä—Ä", en: "Dinosaur" }, icon: "ü¶ñ", cat: "hero" },
            { id: 15, text: { bg: "–†–æ–±–æ—Ç", en: "Robot" }, icon: "ü§ñ", cat: "hero" },
            { id: 16, text: { bg: "–ò–∑–≤—ä–Ω–∑–µ–º–Ω–æ", en: "Alien" }, icon: "üëΩ", cat: "hero" },
            { id: 17, text: { bg: "–§–µ—è", en: "Fairy" }, icon: "üßö", cat: "hero" },
            { id: 18, text: { bg: "–ß—É–¥–æ–≤–∏—â–µ", en: "Monster" }, icon: "üëæ", cat: "hero" },
            { id: 73, text: { bg: "–ö—Ä–∞–ª", en: "King" }, icon: "ü§¥", cat: "hero" },
            { id: 74, text: { bg: "–ö—Ä–∞–ª–∏—Ü–∞", en: "Queen" }, icon: "üë∏", cat: "hero" },
            { id: 75, text: { bg: "–ü–æ–ª–∏—Ü–∞–π", en: "Police" }, icon: "üëÆ", cat: "hero" },
            { id: 76, text: { bg: "–õ–µ–∫–∞—Ä", en: "Doctor" }, icon: "üë©‚Äç‚öïÔ∏è", cat: "hero" },
            { id: 77, text: { bg: "–£—á–µ–Ω", en: "Scientist" }, icon: "üßë‚Äçüî¨", cat: "hero" },
            { id: 78, text: { bg: "–ü—Ä–∏–∑—Ä–∞–∫", en: "Ghost" }, icon: "üëª", cat: "hero" },
            { id: 79, text: { bg: "–ù–∏–Ω–¥–∂–∞", en: "Ninja" }, icon: "ü•∑", cat: "hero" },

            // ITEMS (26-50)
            { id: 19, text: { bg: "–¢–æ–ø–∫–∞", en: "Ball" }, icon: "‚öΩ", cat: "item" },
            { id: 20, text: { bg: "–ú–µ—á–µ", en: "Teddy Bear" }, icon: "üß∏", cat: "item" },
            { id: 21, text: { bg: "–ö–æ–ª–∏—á–∫–∞", en: "Car" }, icon: "üöó", cat: "item" },
            { id: 22, text: { bg: "–ö–æ—Ä–æ–Ω–∞", en: "Crown" }, icon: "üëë", cat: "item" },
            { id: 23, text: { bg: "–ë–∞–ª–æ–Ω", en: "Balloon" }, icon: "üéà", cat: "item" },
            { id: 24, text: { bg: "–ö–Ω–∏–≥–∞", en: "Book" }, icon: "üìñ", cat: "item" },
            { id: 25, text: { bg: "–í—ä–ª—à–µ–±–Ω–∞ –ø—Ä—ä—á–∫–∞", en: "Magic Wand" }, icon: "ü™Ñ", cat: "item" },
            { id: 26, text: { bg: "–õ—ä–∂–∏—Ü–∞", en: "Spoon" }, icon: "ü•Ñ", cat: "item" },
            { id: 27, text: { bg: "–û–±—É–≤–∫–∏", en: "Shoes" }, icon: "üëü", cat: "item" },
            { id: 28, text: { bg: "–ö–ª—é—á", en: "Key" }, icon: "üîë", cat: "item" },
            { id: 29, text: { bg: "–§–µ–Ω–µ—Ä—á–µ", en: "Flashlight" }, icon: "üî¶", cat: "item" },
            { id: 30, text: { bg: "–ü–æ–¥–∞—Ä—ä–∫", en: "Gift" }, icon: "üéÅ", cat: "item" },
            { id: 31, text: { bg: "–ö–æ–ª–µ–ª–æ", en: "Bicycle" }, icon: "üö≤", cat: "item" },
            { id: 32, text: { bg: "–†–∞–∫–µ—Ç–∞", en: "Rocket" }, icon: "üöÄ", cat: "item" },
            { id: 33, text: { bg: "–õ–æ–¥–∫–∞", en: "Boat" }, icon: "‚õµ", cat: "item" },
            { id: 34, text: { bg: "–í–ª–∞–∫", en: "Train" }, icon: "üöÇ", cat: "item" },
            { id: 35, text: { bg: "–¢–æ—Ä—Ç–∞", en: "Cake" }, icon: "üéÇ", cat: "item" },
            { id: 36, text: { bg: "–°–ª–∞–¥–æ–ª–µ–¥", en: "Ice Cream" }, icon: "üç¶", cat: "item" },
            { id: 80, text: { bg: "–¢–µ–ª–µ—Ñ–æ–Ω", en: "Phone" }, icon: "üì±", cat: "item" },
            { id: 81, text: { bg: "–ö–æ–º–ø—é—Ç—ä—Ä", en: "Computer" }, icon: "üíª", cat: "item" },
            { id: 82, text: { bg: "–ú–µ—á", en: "Sword" }, icon: "üó°Ô∏è", cat: "item" },
            { id: 83, text: { bg: "–©–∏—Ç", en: "Shield" }, icon: "üõ°Ô∏è", cat: "item" },
            { id: 84, text: { bg: "–ö–∞—Ä—Ç–∞", en: "Map" }, icon: "üó∫Ô∏è", cat: "item" },
            { id: 85, text: { bg: "–ü–∏—Ü–∞", en: "Pizza" }, icon: "üçï", cat: "item" },
            { id: 86, text: { bg: "–®–∞–ø–∫–∞", en: "Hat" }, icon: "üé©", cat: "item" },

            // PLACES (51-75)
            { id: 37, text: { bg: "–ö—ä—â–∞", en: "House" }, icon: "üè†", cat: "place" },
            { id: 38, text: { bg: "–£—á–∏–ª–∏—â–µ", en: "School" }, icon: "üè´", cat: "place" },
            { id: 39, text: { bg: "–ü—ä—Ä–∑–∞–ª–∫–∞", en: "Slide" }, icon: "üõù", cat: "place" },
            { id: 40, text: { bg: "–ì–æ—Ä–∞", en: "Forest" }, icon: "üå≤", cat: "place" },
            { id: 41, text: { bg: "–ü–ª–∞–∂", en: "Beach" }, icon: "üèñÔ∏è", cat: "place" },
            { id: 42, text: { bg: "–ö–æ—Å–º–æ—Å", en: "Space" }, icon: "ü™ê", cat: "place" },
            { id: 43, text: { bg: "–°–ª—ä–Ω—Ü–µ", en: "Sun" }, icon: "‚òÄÔ∏è", cat: "place" },
            { id: 44, text: { bg: "–õ—É–Ω–∞", en: "Moon" }, icon: "üåô", cat: "place" },
            { id: 45, text: { bg: "–î—ä–≥–∞", en: "Rainbow" }, icon: "üåà", cat: "place" },
            { id: 46, text: { bg: "–î—ä–∂–¥", en: "Rain" }, icon: "üåßÔ∏è", cat: "place" },
            { id: 47, text: { bg: "–°–Ω—è–≥", en: "Snow" }, icon: "‚ùÑÔ∏è", cat: "place" },
            { id: 48, text: { bg: "–¶–≤–µ—Ç–µ", en: "Flower" }, icon: "üå∏", cat: "place" },
            { id: 49, text: { bg: "–ó–∞–º—ä–∫", en: "Castle" }, icon: "üè∞", cat: "place" },
            { id: 50, text: { bg: "–û—Å—Ç—Ä–æ–≤", en: "Island" }, icon: "üèùÔ∏è", cat: "place" },
            { id: 51, text: { bg: "–õ–µ–≥–ª–æ", en: "Bed" }, icon: "üõèÔ∏è", cat: "place" },
            { id: 52, text: { bg: "–†–∞–¥–æ—Å—Ç", en: "Joy" }, icon: "üòä", cat: "place" },
            { id: 53, text: { bg: "–¢—ä–≥–∞", en: "Sadness" }, icon: "üò¢", cat: "place" },
            { id: 54, text: { bg: "–°—ä—Ä—Ü–µ", en: "Heart" }, icon: "‚ù§Ô∏è", cat: "place" },
            { id: 87, text: { bg: "–ì—Ä–∞–¥", en: "City" }, icon: "üèôÔ∏è", cat: "place" },
            { id: 88, text: { bg: "–§–µ—Ä–º–∞", en: "Farm" }, icon: "üöú", cat: "place" },
            { id: 89, text: { bg: "–ë–æ–ª–Ω–∏—Ü–∞", en: "Hospital" }, icon: "üè•", cat: "place" },
            { id: 90, text: { bg: "–¶–∏—Ä–∫", en: "Circus" }, icon: "üé™", cat: "place" },
            { id: 91, text: { bg: "–ü–µ—â–µ—Ä–∞", en: "Cave" }, icon: "üï≥Ô∏è", cat: "place" },
            { id: 92, text: { bg: "–í—É–ª–∫–∞–Ω", en: "Volcano" }, icon: "üåã", cat: "place" },
            { id: 93, text: { bg: "–ü–æ–¥ –≤–æ–¥–∞", en: "Underwater" }, icon: "ü™∏", cat: "place" },

             // ACTIONS (76-100)
            { id: 55, text: { bg: "–¢–∏—á–∞", en: "Run" }, icon: "üèÉ", cat: "action" },
            { id: 56, text: { bg: "–°–ø–∏", en: "Sleep" }, icon: "üò¥", cat: "action" },
            { id: 57, text: { bg: "–Ø–¥–µ", en: "Eat" }, icon: "üçΩÔ∏è", cat: "action" },
            { id: 58, text: { bg: "–õ–µ—Ç–∏", en: "Fly" }, icon: "‚úàÔ∏è", cat: "action" },
            { id: 59, text: { bg: "–ü–ª—É–≤–∞", en: "Swim" }, icon: "üèä", cat: "action" },
            { id: 60, text: { bg: "–ß–µ—Ç–µ", en: "Read" }, icon: "üìñ", cat: "action" },
            { id: 61, text: { bg: "–†–∏—Å—É–≤–∞", en: "Paint" }, icon: "üé®", cat: "action" },
            { id: 62, text: { bg: "–ü–µ–µ", en: "Sing" }, icon: "üé§", cat: "action" },
            { id: 63, text: { bg: "–¢–∞–Ω—Ü—É–≤–∞", en: "Dance" }, icon: "üíÉ", cat: "action" },
            { id: 64, text: { bg: "–ò–≥—Ä–∞–µ", en: "Play" }, icon: "üéÆ", cat: "action" },
            { id: 65, text: { bg: "–¢—ä—Ä—Å–∏", en: "Search" }, icon: "üîç", cat: "action" },
            { id: 66, text: { bg: "–ì–æ—Ç–≤–∏", en: "Cook" }, icon: "üç≥", cat: "action" },
            { id: 67, text: { bg: "–ú–∏—Å–ª–∏", en: "Think" }, icon: "ü§î", cat: "action" },
            { id: 68, text: { bg: "–°–º–µ–µ —Å–µ", en: "Laugh" }, icon: "üòÇ", cat: "action" },
            { id: 69, text: { bg: "–ü–ª–∞—á–µ", en: "Cry" }, icon: "üò≠", cat: "action" },
            { id: 70, text: { bg: "–û–±–∏—á–∞", en: "Love" }, icon: "üòç", cat: "action" },
            { id: 71, text: { bg: "–°—Ç—Ä–æ–∏", en: "Build" }, icon: "üß±", cat: "action" },
            { id: 72, text: { bg: "–ö–∞—Ç–µ—Ä–∏ —Å–µ", en: "Climb" }, icon: "üßó", cat: "action" },
            { id: 94, text: { bg: "–ë–∏–µ —Å–µ", en: "Fight" }, icon: "‚öîÔ∏è", cat: "action" },
            { id: 95, text: { bg: "–®–æ—Ñ–∏—Ä–∞", en: "Drive" }, icon: "üöó", cat: "action" },
            { id: 96, text: { bg: "–ö—Ä–∏–µ —Å–µ", en: "Hide" }, icon: "ü´£", cat: "action" },
            { id: 97, text: { bg: "–ö—ä–ø–µ —Å–µ", en: "Bath" }, icon: "üõÅ", cat: "action" },
            { id: 98, text: { bg: "–ü–∞–∑–∞—Ä—É–≤–∞", en: "Shop" }, icon: "üõí", cat: "action" },
            { id: 99, text: { bg: "–ü–∏—à–µ", en: "Write" }, icon: "‚úçÔ∏è", cat: "action" },
            { id: 100, text: { bg: "–°–Ω–∏–º–∞", en: "Photo" }, icon: "üì∏", cat: "action" }
        ];

        let currentItems = [];
        let swapCounts = [];
        let lockedStates = [];
        let voices = [];
        let currentLang = 'bg';

        // --- LOCAL STORAGE ---
        function saveSettings() {
            const settings = {
                lang: currentLang,
                darkMode: document.body.classList.contains('dark-mode'),
                count: document.getElementById('count-select').value,
                level: document.getElementById('level-select').value
            };
            localStorage.setItem('storyDiceSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('storyDiceSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                if (settings.lang) currentLang = settings.lang;
                document.querySelector('.lang-btn').textContent = currentLang.toUpperCase();

                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.querySelector('.dark-btn').textContent = '‚òÄÔ∏è';
                }
                if (settings.count) document.getElementById('count-select').value = settings.count;
                if (settings.level) document.getElementById('level-select').value = settings.level;
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'bg' ? 'en' : 'bg';
            document.querySelector('.lang-btn').textContent = currentLang.toUpperCase();
            saveSettings();
            updateUI();

            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                const item = currentItems[index];
                if (item) card.querySelector('.card-text').textContent = item.text[currentLang];
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const btn = document.querySelector('.dark-btn');
            btn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
            saveSettings();
        }

        function updateUI() {
            const t = uiText[currentLang];
            document.getElementById('ui-title').textContent = t.title;
            document.getElementById('ui-hero').textContent = t.hero;
            document.getElementById('ui-item').textContent = t.item;
            document.getElementById('ui-place').textContent = t.place;
            document.getElementById('ui-action').textContent = t.action;

            document.getElementById('ui-save').textContent = t.save;
            document.getElementById('ui-roll').textContent = t.roll;

            // Update Options
            document.getElementById('opt-beginner').textContent = t.optBeginner;
            document.getElementById('opt-advanced').textContent = t.optAdvanced;
            document.getElementById('opt-expert').textContent = t.optExpert;

            // –õ–µ–≥–µ–Ω–¥–∞ - —Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –ù–∞—á–∏–Ω–∞–µ—â
            const level = document.getElementById('level-select').value;
            if(level === 'beginner') {
                document.getElementById('leg-action').classList.add('dimmed');
            } else {
                document.getElementById('leg-action').classList.remove('dimmed');
            }

            const modalContent = document.getElementById('modal-text-content');
            modalContent.innerHTML = `
                <h2>${t.modalTitle}</h2>
                ${t.modalSteps.map(s => `<p>${s}</p>`).join('')}
                <h3>${t.modalTipsTitle}</h3>
                <ul>${t.modalTips.map(tip => `<li>${tip}</li>`).join('')}</ul>
            `;
        }

        // --- TTS ---
        function initVoices() { voices = window.speechSynthesis.getVoices(); }
        if ('speechSynthesis' in window) { window.speechSynthesis.onvoiceschanged = initVoices; initVoices(); }

        function speak(textObj, cardElement) {
            if (!('speechSynthesis' in window)) return;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('speaking'));
            if(cardElement) {
                cardElement.classList.add('speaking');
                setTimeout(() => cardElement.classList.remove('speaking'), 1000);
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(textObj[currentLang]);
            if (voices.length === 0) voices = window.speechSynthesis.getVoices();
            utterance.lang = currentLang === 'bg' ? 'bg-BG' : 'en-US';
            window.speechSynthesis.speak(utterance);
        }

        // --- MODAL ---
        function openModal() { updateUI(); document.getElementById('infoModal').style.display = 'flex'; }
        function closeModal(event, force) {
            if (force || event.target.id === 'infoModal') document.getElementById('infoModal').style.display = 'none';
        }

        // --- LOGIC ---
        function shuffle(array) {
            let cur = array.length, rnd;
            const newArr = [...array];
            while (cur != 0) {
                rnd = Math.floor(Math.random() * cur);
                cur--;
                [newArr[cur], newArr[rnd]] = [newArr[rnd], newArr[cur]];
            }
            return newArr;
        }

        function rollAllWithAnimation() {
            const board = document.getElementById('game-board');
            if (board.children.length > 0) {
                Array.from(board.children).forEach((c, i) => {
                    if (!lockedStates[i]) c.classList.add('animate-shake');
                });
                setTimeout(rollAll, 300);
            } else {
                rollAll();
            }
        }

        function rollAll() {
            saveSettings();
            updateUI(); // –û–±–Ω–æ–≤—è–≤–∞ –ª–µ–≥–µ–Ω–¥–∞—Ç–∞ –ø—Ä–∏ —Å–º—è–Ω–∞ –Ω–∞ –Ω–∏–≤–æ

            const count = parseInt(document.getElementById('count-select').value);
            const level = document.getElementById('level-select').value;
            const board = document.getElementById('game-board');

            if (currentItems.length !== count) {
                currentItems = new Array(count).fill(null);
                swapCounts = new Array(count).fill(0);
                lockedStates = new Array(count).fill(false);
                board.innerHTML = '';
            }

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            const heroes = shuffle(db.filter(x => x.cat === 'hero'));
            const items = shuffle(db.filter(x => x.cat === 'item'));
            const places = shuffle(db.filter(x => x.cat === 'place'));
            const actions = shuffle(db.filter(x => x.cat === 'action'));

            let selectionPlan = [];

            // 1. BEGINNER (3 Categories: Hero, Item, Place)
            if (level === 'beginner') {
                let limits = { hero: 0, item: 0, place: 0 };
                const cats3 = ['hero', 'item', 'place'];
                const rnd3 = () => cats3[Math.floor(Math.random() * cats3.length)];

                // –°—Ç—Ä–∏–∫—Ç–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞ 3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                switch(count) {
                    case 3: limits = {hero:1, item:1, place:1}; break;
                    case 4: limits = {hero:1, item:1, place:1}; limits[rnd3()]++; break;
                    case 5: limits = {hero:2, item:2, place:2}; limits[rnd3()]--; break;
                    case 6: limits = {hero:2, item:2, place:2}; break;
                    case 7: limits = {hero:2, item:2, place:2}; limits[rnd3()]++; break;
                    case 8: limits = {hero:3, item:3, place:3}; limits[rnd3()]--; break;
                    case 9: limits = {hero:3, item:3, place:3}; break;
                    default: limits = {hero:1, item:1, place:1}; // Fallback
                }
                // –ì–µ–Ω–µ—Ä–∏—Ä–∞–º–µ –ø–ª–∞–Ω–∞ –∑–∞ –º–∞—Å–∏–≤–∞
                for(let k=0; k<limits.hero; k++) selectionPlan.push('hero');
                for(let k=0; k<limits.item; k++) selectionPlan.push('item');
                for(let k=0; k<limits.place; k++) selectionPlan.push('place');
                selectionPlan = shuffle(selectionPlan);
            }

            // 2. ADVANCED (4 Categories: Hero, Action, Item, Place)
            else if (level === 'advanced') {
                let limits = { hero: 0, action: 0, item: 0, place: 0 };
                const cats4 = ['hero', 'action', 'item', 'place'];
                const rnd4 = () => cats4[Math.floor(Math.random() * cats4.length)];

                // –°—Ç—Ä–∏–∫—Ç–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞ 4 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                switch(count) {
                    case 3: limits = {hero:1, action:1, item:1, place:0}; break; // Fallback –º–∞–∫–∞—Ä –º–∏–Ω –¥–∞ –µ 4
                    case 4: limits = {hero:1, action:1, item:1, place:1}; break;
                    case 5: limits = {hero:1, action:1, item:1, place:1}; limits[rnd4()]++; break;
                    case 6: limits = {hero:1, action:1, item:1, place:1}; limits[rnd4()]++; limits[rnd4()]++; break; // +2 random
                    case 7: limits = {hero:2, action:2, item:2, place:2}; limits[rnd4()]--; break;
                    case 8: limits = {hero:2, action:2, item:2, place:2}; break;
                    case 9: limits = {hero:2, action:2, item:2, place:2}; limits[rnd4()]++; break;
                }
                 // –ì–µ–Ω–µ—Ä–∏—Ä–∞–º–µ –ø–ª–∞–Ω–∞
                for(let k=0; k<limits.hero; k++) selectionPlan.push('hero');
                for(let k=0; k<limits.action; k++) selectionPlan.push('action');
                for(let k=0; k<limits.item; k++) selectionPlan.push('item');
                for(let k=0; k<limits.place; k++) selectionPlan.push('place');

                // –ê–∫–æ —Å–ª—É—á–∞–π–Ω–æ –Ω–∞–¥–≤–∏—à–∏ count (–ø—Ä–∏ 6 –∫–∞—Ä—Ç–∏ —Å –ø–æ–≤—Ç–∞—Ä—è—â —Å–µ random), –æ—Ä—è–∑–≤–∞–º–µ
                while(selectionPlan.length > count) selectionPlan.pop();
                // –ê–∫–æ –ª–∏–ø—Å–≤–∞ (–ø—Ä–∏ —Å–ª–æ–∂–Ω–∞ —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è), –¥–æ–±–∞–≤—è–º–µ
                while(selectionPlan.length < count) selectionPlan.push(rnd4());

                selectionPlan = shuffle(selectionPlan);
            }

            // 3. EXPERT (Chaos / Random Mix)
            else {
                const cats = ['hero', 'item', 'place', 'action'];
                for(let k=0; k<count; k++) {
                    selectionPlan.push(cats[Math.floor(Math.random() * cats.length)]);
                }
            }

            let newItems = [];
            let hI=0, iI=0, pI=0, aI=0;

            for (let i = 0; i < count; i++) {
                if (lockedStates[i] && currentItems[i]) {
                    newItems.push(currentItems[i]);
                } else {
                    swapCounts[i] = 0;
                    let category = selectionPlan[i] || 'hero';
                    let candidate;
                    if (category === 'hero') candidate = heroes[hI++];
                    else if (category === 'item') candidate = items[iI++];
                    else if (category === 'place') candidate = places[pI++];
                    else if (category === 'action') candidate = actions[aI++];
                    newItems.push(candidate);
                }
            }

            currentItems = newItems;
            board.innerHTML = '';
            currentItems.forEach((item, index) => createCardDOM(item, index));
        }

        function changeOne(index) {
            if (swapCounts[index] >= 2 || lockedStates[index]) return;
            const currentCard = currentItems[index];
            const visibleIds = currentItems.map(x => x.id);
            const available = db.filter(x => !visibleIds.includes(x.id) && x.cat === currentCard.cat);
            if(available.length === 0) return;

            swapCounts[index]++;
            const newItem = available[Math.floor(Math.random() * available.length)];
            currentItems[index] = newItem;

            const wrapper = document.createElement('div');
            createCardDOM(newItem, index, wrapper);
            document.getElementById('game-board').children[index].replaceWith(wrapper.firstElementChild);
        }

        function toggleLock(index) {
            lockedStates[index] = !lockedStates[index];
            const wrapper = document.createElement('div');
            createCardDOM(currentItems[index], index, wrapper);
            document.getElementById('game-board').children[index].replaceWith(wrapper.firstElementChild);
        }

        function createCardDOM(item, index, parent = document.getElementById('game-board')) {
            const card = document.createElement('div');
            const isLocked = lockedStates[index];
            card.className = `card cat-${item.cat} animate-pop ${isLocked ? 'locked' : ''}`;
            card.onclick = () => speak(item.text, card);

            const icon = document.createElement('div');
            icon.className = 'card-icon';
            icon.textContent = item.icon;
            const text = document.createElement('div');
            text.className = 'card-text';
            text.textContent = item.text[currentLang];

            const lockBtn = document.createElement('div');
            lockBtn.className = 'card-btn lock-btn';
            lockBtn.innerHTML = isLocked ? 'üîí' : 'üîì';
            lockBtn.onclick = (e) => { e.stopPropagation(); toggleLock(index); };
            card.appendChild(lockBtn);

            if (!isLocked && swapCounts[index] < 2) {
                const swapBtn = document.createElement('div');
                swapBtn.className = 'card-btn swap-btn';
                let dotsHTML = '<div class="swap-dots">';
                const remaining = 2 - swapCounts[index];
                for(let i=0; i<remaining; i++) {
                    dotsHTML += '<span class="swap-dot"></span>';
                }
                dotsHTML += '</div>';
                swapBtn.innerHTML = dotsHTML;
                swapBtn.onclick = (e) => { e.stopPropagation(); changeOne(index); };
                card.appendChild(swapBtn);
            }

            card.appendChild(icon);
            card.appendChild(text);
            parent.appendChild(card);
        }

        function takeScreenshot() {
            html2canvas(document.body).then(canvas => {
                const link = document.createElement('a');
                link.download = 'story-dice-' + Date.now() + '.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        window.onload = function() {
            loadSettings();
            // –ê–∫–æ –Ω—è–º–∞ –∑–∞–ø–∏—Å–∞–Ω–æ –Ω–∏–≤–æ, —Å–ª–∞–≥–∞–º–µ Beginner –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
            if(!localStorage.getItem('storyDiceSettings')) {
                document.getElementById('level-select').value = 'beginner';
            }
            updateUI();
            rollAll();
        };
    </script>
</body>
</html>
